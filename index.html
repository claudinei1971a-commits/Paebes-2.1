<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TESTE DE CONHECIMENTO</title>
    <!-- Carrega o Tailwind CSS para estiliza√ß√£o -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Define a fonte Inter como padr√£o e um fundo escuro */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1e3a8a; /* Azul escuro */
            color: white;
            min-height: 100vh;
        }

        /* Cores baseadas na imagem do usu√°rio */
        .header-bg {
            background-color: #1e3a8a;
        }
        .main-quiz-box {
            background-color: #ef4444; /* Vermelho/Laranja para a caixa de pergunta */
        }
        .sidebar-box {
            background-color: #3b82f6; /* Azul m√©dio para a barra lateral */
        }
        .button-parar {
            background-color: #dc2626; /* Vermelho forte */
        }
        .button-next {
            background-color: #6366f1; /* Roxo suave para Pr√≥xima Pergunta */
        }
        .button-next:hover {
            background-color: #4f46e5;
        }
        /* Estilo base para todos os bot√µes de linhas de vida (Ajuda, Cartas, Placas, Convidados) */
        .lifeline-button {
            background-color: #f97316; /* Laranja */
            transition: transform 0.1s, background-color 0.2s;
            height: 70px; /* Altura fixa para os bot√µes de linha de vida */
        }
        .lifeline-button:hover:not(:disabled) {
            transform: scale(1.05);
            background-color: #ea580c;
        }
        .lifeline-button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            background-color: #9ca3af; /* Cinza para desabilitado */
        }
        .score-button {
            background-color: #10b981; /* Verde esmeralda para o bot√£o de acerto */
            transition: background-color 0.2s;
        }
        .score-button:hover {
            background-color: #059669;
        }
        .timer-display {
            font-size: 3rem;
            line-height: 1;
        }
        .option-button {
            background-color: #4f46e5; /* Roxo para op√ß√µes */
            transition: background-color 0.2s, opacity 0.2s;
        }
        .option-button:hover:not(:disabled) {
            background-color: #4338ca;
        }
        .option-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .correct-answer {
            background-color: #10b981; /* Verde */
        }
        .wrong-answer {
            background-color: #dc2626; /* Vermelho */
        }
        .eliminated-option {
            text-decoration: line-through;
            opacity: 0.3;
        }
        .ranking-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        .ranking-table th, .ranking-table td {
            padding: 8px;
            border-bottom: 1px solid #ddd;
            text-align: left;
        }
        .ranking-table th {
            background-color: #e5e7eb;
            color: #1f2937;
            font-weight: bold;
        }
    </style>
</head>
<body class="flex flex-col items-center"> <!-- REMOVIDO: p-4 do body -->

    <!-- START SCREEN OVERLAY (TELA DE IN√çCIO) -->
    <div id="start-screen" class="fixed inset-0 bg-blue-900 flex flex-col items-center justify-center p-8 z-50">
        <!-- T√çTULO DE BOAS-VINDAS (H1 ATUALIZADO) -->
        <h1 class="text-2xl sm:text-3xl font-extrabold tracking-widest text-white drop-shadow-lg mb-4">
            SEJA BEM VINDO, PREPARE-SE PARA UMA GRANDE AVENTURA!
        </h1>
        <div class="bg-red-600 p-8 rounded-xl shadow-2xl text-center max-w-xl w-full">
            <!-- T√çTULO PRINCIPAL (H2 ATUALIZADO E CENTRALIZADO) -->
            <h2 class="text-4xl sm:text-5xl font-extrabold tracking-widest text-yellow-300 drop-shadow-lg mb-8">
                TESTE DE CONHECIMENTO
            </h2>
            <p class="text-lg mb-6">
                <!-- TEXTO ALTERADO AQUI -->
                Responda todas as quest√µes, assinalando a alternativa correta.
            </p>
            
            <!-- NOVOS CAMPOS DE INPUT -->
            <div class="flex flex-col gap-4 mb-6">
                <input type="text" id="user-name-input" placeholder="Seu Nome Completo" class="p-3 rounded text-gray-900 placeholder-gray-500 focus:ring-2 focus:ring-green-500">
                <input type="text" id="user-class-input" placeholder="Sua Turma (Ex: 3¬∫ A)" class="p-3 rounded text-gray-900 placeholder-gray-500 focus:ring-2 focus:ring-green-500">
            </div>
            
            <!-- Mensagem de erro para input vazio -->
            <p id="start-error-message" class="text-yellow-200 mb-4 hidden">Por favor, preencha seu nome e turma para come√ßar.</p>

            <button id="start-action-btn" class="bg-green-500 hover:bg-green-600 px-12 py-4 rounded-lg font-extrabold text-xl shadow-xl transition duration-300 transform hover:scale-105">
                A√á√ÉO
            </button>
        </div>
    </div>
    
    <!-- Cabe√ßalho do T√≠tulo Principal (Vis√≠vel no Jogo) -->
    <header class="w-full max-w-7xl text-center py-6 px-4">
        <!-- T√çTULO ATUALIZADO AQUI -->
        <h1 class="text-2xl sm:text-3xl font-extrabold tracking-widest text-white drop-shadow-lg">
            TESTE DE CONHECIMENTO
        </h1>
    </header>

    <!-- Container Principal do Jogo (HIDDEN AT√â O IN√çCIO) -->
    <div id="main-quiz-container" class="w-full max-w-7xl flex flex-col lg:flex-row gap-6 hidden p-4"> <!-- ADICIONADO: p-4 para manter o padding principal -->

        <!-- Coluna Principal do Quiz (Esquerda) -->
        <main class="lg:w-3/4 flex flex-col gap-6">
            
            <!-- Caixa de Pergunta -->
            <div id="quiz-box" class="main-quiz-box p-6 sm:p-8 rounded-lg shadow-2xl min-h-[300px] flex flex-col justify-center">
                <h2 class="text-xl sm:text-2xl font-bold mb-4" id="quiz-title">
                    Pergunta
                </h2>
                <p id="question-text" class="text-lg sm:text-xl font-medium">
                    Aguardando Carregamento...
                </p>
                <p id="topic-info" class="text-sm italic mt-2">
                    Conte√∫do: 
                </p>
            </div>

            <!-- Op√ß√µes de Resposta -->
            <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- As op√ß√µes ser√£o inseridas aqui via JavaScript -->
            </div>
            
            <!-- Bot√£o Pr√≥xima Pergunta -->
            <button id="next-question-btn" class="button-next px-8 py-4 rounded-lg font-bold text-lg shadow-xl self-center transition duration-300 transform hover:scale-[1.02] hidden">
                PR√ìXIMA PERGUNTA
            </button>
            
            <!-- Bot√£o de Revis√£o (Oculto at√© o fim do quiz) -->
            <button id="review-btn" class="bg-yellow-500 hover:bg-yellow-600 px-8 py-4 rounded-lg font-bold text-lg shadow-xl self-center transition duration-300 transform hover:scale-[1.02] mt-4 hidden">
                INICIAR REVIS√ÉO
            </button>
            
            <!-- Bot√£o de Reiniciar (Oculto at√© o fim do quiz) -->
            <button id="restart-btn" class="bg-blue-500 hover:bg-blue-600 px-8 py-4 rounded-lg font-bold text-lg shadow-xl self-center transition duration-300 transform hover:scale-[1.02] mt-4 hidden">
                REINICIAR
            </button>

            <!-- Bot√£o Tentar Novamente (Oculto at√© o fim da revis√£o com erro) -->
             <button id="retry-btn" class="bg-purple-600 hover:bg-purple-700 px-8 py-4 rounded-lg font-bold text-lg shadow-xl self-center transition duration-300 transform hover:scale-[1.02] mt-4 hidden">
                TENTAR NOVAMENTE
            </button>

        </main>

        <!-- Barra Lateral (Direita) - Simplificada -->
        <aside class="lg:w-1/4 flex flex-col gap-4">
            
            <!-- Bot√£o PARAR (Topo da Sidebar) -->
            <button id="parar-btn" class="button-parar px-6 py-3 rounded-lg font-bold text-xl shadow-xl transition duration-300 hover:opacity-90">
                PARAR
            </button>

            <!-- NOVO: Tempo Gasto (Contador Progressivo) -->
            <div class="sidebar-box p-4 rounded-lg shadow-xl text-center">
                <p class="font-bold text-sm">TEMPO GASTO</p>
                <div id="progressive-timer-display" class="timer-display font-mono font-extrabold">00:00:00</div>
            </div>
            
            <!-- NOVAS LINHAS DE VIDA (AJUDAR, DICA, EXEMPLO) -->
            <div class="grid grid-cols-3 gap-2 mt-2">
                <!-- AJUDAR (Ajuda Completa) -->
                <button id="ajudar-btn" class="lifeline-button p-3 rounded-lg text-center font-bold text-xs sm:text-base disabled:bg-gray-700">
                    <span class="text-2xl block">üí°</span> AJUDAR
                </button>
                <!-- DICA (Dica Simples - Antigo Hint) -->
                <button id="dica-btn" class="lifeline-button p-3 rounded-lg text-center font-bold text-xs sm:text-base disabled:bg-gray-700">
                    <span class="text-2xl block">üîç</span> DICA
                </button>
                <!-- EXEMPLO (Exemplo Similar Resolvido) -->
                <button id="exemplo-btn" class="lifeline-button p-3 rounded-lg text-center font-bold text-xs sm:text-base disabled:bg-gray-700">
                    <span class="text-2xl block">üìã</span> EXEMPLO
                </button>
            </div>
            
            <!-- Pontua√ß√£o Atual - Simplificada -->
            <div class="sidebar-box p-4 rounded-lg shadow-xl mt-4">
                <p class="text-xl font-bold mb-2">PONTUA√á√ÉO: <span id="current-score" class="font-mono text-yellow-300">0</span></p>
                <hr class="border-gray-500 mb-2">
                <p>ACERTOS: <span id="consecutive-correct" class="font-mono text-lg">0</span></p>
                <!-- ALTERADO: 1 MIL para 1 PONTO -->
                <p>PR√ìXIMO: <span class="font-mono text-lg text-green-300">1 PONTO</span></p>
                <div id="message-box" class="mt-4 p-2 bg-yellow-600 rounded text-sm hidden"></div>
            </div>
            
            <!-- NOVO BOT√ÉO CLASSIFICA√á√ÉO -->
            <button id="ranking-btn" class="bg-gray-600 hover:bg-gray-700 px-6 py-3 rounded-lg font-bold text-xl shadow-xl transition duration-300 hover:opacity-90 mt-4">
                CLASSIFICA√á√ÉO
            </button>

        </aside>
    </div>

    <!-- JavaScript do Quiz -->
    <script type="module">
        // Importa√ß√µes do Firebase (Usando URLs do CDN para ambiente de arquivo √∫nico)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, getDocs, limit, serverTimestamp, setLogLevel, doc, onSnapshot, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Array de objetos com as 10 perguntas PRINCIPAIS
        const questions = [
            {
                topic: "Geometria Plana (Semelhan√ßa e Trigonometria)",
                question: "Um arquiteto precisa fazer um projeto para uma casa. Ele usou uma figura semelhante para a planta da casa. Qual das alternativas apresenta figuras semelhantes?",
                options: ["Um tri√¢ngulo e um ret√¢ngulo.", "Dois tri√¢ngulos com os mesmos √¢ngulos, mas lados diferentes.", "Um c√≠rculo e uma elipse.", "Um quadrado e um ret√¢ngulo."],
                answerIndex: 1, // B) Dois tri√¢ngulos com os mesmos √¢ngulos, mas lados diferentes.
                explanation: "Figuras semelhantes mant√™m a propor√ß√£o entre os lados correspondentes e possuem os √¢ngulos internos congruentes. A igualdade de √¢ngulos garante a semelhan√ßa mesmo com tamanhos (lados) diferentes.",
                dica_simples: "Semelhan√ßa exige a manuten√ß√£o dos √¢ngulos e proporcionalidade dos lados, n√£o a igualdade dos lados.",
                ajudar_completa: "Para que duas figuras sejam semelhantes, a √∫nica regra r√≠gida √© que os √¢ngulos internos sejam mantidos exatamente iguais. O tamanho (comprimento dos lados) pode ser diferente, desde que a propor√ß√£o entre os lados correspondentes seja mantida (raz√£o de semelhan√ßa). Se os √¢ngulos s√£o iguais, a semelhan√ßa est√° garantida, independentemente do comprimento dos lados.",
                exemplo_similar: "Exemplo: Um mapa da cidade √© semelhante √† cidade real. Os √¢ngulos das ruas s√£o os mesmos, mas o tamanho no papel √© muito menor. Assim, a forma √© id√™ntica (√¢ngulos iguais), mas o tamanho √© diferente."
            },
            {
                topic: "Geometria Plana (Teorema de Pit√°goras)",
                question: "Um tri√¢ngulo ret√¢ngulo tem um cateto medindo 3 cm e outro cateto medindo 4 cm. Qual √© a medida da hipotenusa?",
                options: ["5 cm", "7 cm", "6 cm", "8 cm"],
                answerIndex: 0, // A) 5 cm
                explanation: "Pelo Teorema de Pit√°goras (a¬≤ + b¬≤ = c¬≤), temos 3¬≤ + 4¬≤ = c¬≤. 9 + 16 = 25. A raiz quadrada de 25 √© 5 cm.",
                dica_simples: "Use a f√≥rmula: cateto¬≤ + cateto¬≤ = hipotenusa¬≤. Lembre-se que 3, 4 e 5 formam uma terna pitag√≥rica.",
                ajudar_completa: "O Teorema de Pit√°goras se aplica a tri√¢ngulos ret√¢ngulos. A soma dos quadrados dos catetos (os lados que formam o √¢ngulo de 90 graus) √© igual ao quadrado da hipotenusa (o lado oposto ao √¢ngulo de 90 graus). Use a f√≥rmula: a¬≤ + b¬≤ = c¬≤, onde 'c' √© a hipotenusa e 'a' e 'b' s√£o os catetos.",
                exemplo_similar: "Exemplo: Se os catetos medem 6 e 8, a hipotenusa seria: 6¬≤ + 8¬≤ = 36 + 64 = 100. Hipotenusa = 10."
            },
            {
                topic: "Geometria Espacial (Planifica√ß√£o)",
                question: "Qual das op√ß√µes abaixo representa corretamente a planifica√ß√£o de um cubo?",
                options: ["Um quadrado e um tri√¢ngulo.", "Seis quadrados dispostos em cruz.", "Um c√≠rculo e um quadrado.", "Um ret√¢ngulo e dois tri√¢ngulos."],
                answerIndex: 1, // B) Seis quadrados dispostos em cruz.
                explanation: "Um cubo √© composto por 6 faces quadradas. A planifica√ß√£o mais comum √© a cruz, onde quatro quadrados est√£o em linha, e um em cada lado do segundo quadrado.",
                dica_simples: "Um cubo tem 6 faces quadradas id√™nticas. Pense em como voc√™ o 'desmontaria' em uma folha plana.",
                ajudar_completa: "Um cubo √© um s√≥lido plat√¥nico com 6 faces, 12 arestas e 8 v√©rtices. Todas as faces s√£o quadradas e iguais. A planifica√ß√£o √© a representa√ß√£o plana dessas 6 faces desdobradas. O desenho mais comum e f√°cil de visualizar √© a 'cruz' ou 'T', onde uma fileira de quatro quadrados tem um quadrado anexado acima e outro abaixo do segundo quadrado.",
                exemplo_similar: "Exemplo: A planifica√ß√£o de uma caixa de pizza quadrada √© um quadrado (fundo) e quatro ret√¢ngulos laterais (paredes). J√° o cubo s√≥ tem faces quadradas. Pense em como seria a planifica√ß√£o de um dado."
            },
            {
                topic: "Geometria Espacial (Rela√ß√£o de Euler)",
                question: "Um cubo tem 8 v√©rtices, 12 arestas e 6 faces. Qual √© a rela√ß√£o que podemos estabelecer entre essas caracter√≠sticas?",
                options: ["O n√∫mero de arestas √© igual ao n√∫mero de faces.", "O n√∫mero de v√©rtices √© igual ao n√∫mero de faces.", "A soma do n√∫mero de v√©rtices √© igual √† soma do n√∫mero de arestas e faces.", "A soma do n√∫mero de v√©rtices e faces √© igual ao n√∫mero de arestas somado a 2."],
                answerIndex: 3, // D) A soma do n√∫mero de v√©rtices e faces √© igual ao n√∫mero de arestas somado a 2.
                explanation: "A rela√ß√£o correta √© a Rela√ß√£o de Euler: V - A + F = 2, ou V + F = A + 2. (8 + 6 = 12 + 2, ou seja, 14 = 14).",
                dica_simples: "A f√≥rmula de Euler √© V - A + F = 2. Substitua os valores conhecidos e resolva para a rela√ß√£o.",
                ajudar_completa: "A Rela√ß√£o de Euler √© fundamental para poliedros convexos: V - A + F = 2, onde V = V√©rtices, A = Arestas e F = Faces. A pergunta pede uma rela√ß√£o entre essas caracter√≠sticas. Reorganizando a f√≥rmula: V + F = A + 2. A soma de V√©rtices e Faces √© igual ao n√∫mero de Arestas mais 2.",
                exemplo_similar: "Exemplo (Tetraedro): 4 V√©rtices, 6 Arestas, 4 Faces. V+F = 4+4 = 8. A+2 = 6+2 = 8. A rela√ß√£o se mant√©m: V+F = A+2."
            },
            {
                topic: "Geometria Anal√≠tica (Reta e Ponto)",
                question: "Um ponto A est√° localizado nas coordenadas (3, 4) e um ponto B nas coordenadas (7, 1). Qual √© a localiza√ß√£o do ponto m√©dio entre A e B?",
                options: ["(5, 2.5)", "(10, 5)", "(4, 3)", "(3.5, 4.5)"],
                answerIndex: 0, // A) (5, 2.5)
                explanation: "A coordenada do ponto m√©dio (Xm, Ym) √© a m√©dia aritm√©tica das coordenadas x e y. Xm = (3 + 7) / 2 = 5. Ym = (4 + 1) / 2 = 2.5. O ponto m√©dio √© (5, 2.5).",
                dica_simples: "O ponto m√©dio √© a m√©dia das coordenadas: (x1 + x2)/2 e (y1 + y2)/2.",
                ajudar_completa: "Para encontrar o ponto m√©dio (M) entre dois pontos A(x1, y1) e B(x2, y2), voc√™ deve calcular a m√©dia aritm√©tica das coordenadas x e a m√©dia aritm√©tica das coordenadas y. F√≥rmula: M = ( (x1 + x2) / 2 , (y1 + y2) / 2 ). Basta somar as coordenadas e dividir por dois.",
                exemplo_similar: "Exemplo: O ponto m√©dio entre (1, 5) e (9, 15) seria: Xm = (1+9)/2 = 5. Ym = (5+15)/2 = 10. Ponto M√©dio = (5, 10)."
            },
            // NOVAS 5 QUEST√ïES ADICIONADAS AO QUIZ PRINCIPAL
            { // Adicionada do t√≥pico Semelhan√ßa/Trigonometria
                topic: "Geometria Plana (Semelhan√ßa e Trigonometria)",
                question: "Em um tri√¢ngulo ret√¢ngulo, se o √¢ngulo oposto ao cateto de 3 cm √© de 30 graus, qual √© o valor do seno desse √¢ngulo?",
                options: ["1/2", "3/5", "1", "raiz(3)/2"],
                answerIndex: 0, 
                explanation: "O valor do seno de 30 graus √© uma constante trigonom√©trica: Sen(30¬∞) = 1/2. O valor do cateto (3 cm) √© uma distra√ß√£o neste caso.",
                dica_simples: "Lembre-se da tabela de √¢ngulos not√°veis: Seno de 30 graus.",
                ajudar_completa: "Para encontrar o valor do seno, utilize a raz√£o trigonom√©trica: Seno = Cateto Oposto / Hipotenusa. No entanto, para √¢ngulos not√°veis como 30¬∞, 45¬∞ e 60¬∞, o valor do seno √© fixo. O lado oposto √© fornecido, mas n√£o √© necess√°rio, pois Sen(30¬∞) √© um valor fundamental.",
                exemplo_similar: "Exemplo: O valor do cosseno de 60 graus tamb√©m √© 1/2."
            },
            { // Adicionada do t√≥pico Pit√°goras
                topic: "Geometria Plana (Teorema de Pit√°goras)",
                question: "Durante uma aula de matem√°tica, a professora desenhou um tri√¢ngulo ret√¢ngulo. Um dos catetos mede 5 cm e o outro cateto mede 12 cm. Qual √© a medida da hipotenusa?",
                options: ["13 cm", "11 cm", "10 cm", "15 cm"],
                answerIndex: 0, 
                explanation: "Pelo Teorema de Pit√°goras (a¬≤ + b¬≤ = c¬≤): 5¬≤ + 12¬≤ = c¬≤. 25 + 144 = 169. A raiz quadrada de 169 √© 13 cm.",
                dica_simples: "Lembre-se da terna pitag√≥rica 5, 12 e 13.",
                ajudar_completa: "Use a f√≥rmula: (Cateto 1)¬≤ + (Cateto 2)¬≤ = (Hipotenusa)¬≤. Substitua os valores: 5¬≤ + 12¬≤ = c¬≤. Calcule a soma e, em seguida, encontre a raiz quadrada do resultado.",
                exemplo_similar: "Exemplo: Em um tri√¢ngulo com catetos 9 e 12, a hipotenusa √© 15, pois 9¬≤ + 12¬≤ = 81 + 144 = 225, e a raiz de 225 √© 15."
            },
            { // Adicionada do t√≥pico Planifica√ß√£o
                topic: "Geometria Espacial (Planifica√ß√£o)",
                question: "Um estudante precisa desenhar a planifica√ß√£o de um paralelep√≠pedo. Quantas faces ele deve desenhar?",
                options: ["4", "6", "8", "5"],
                answerIndex: 1, // B) 6
                explanation: "Um paralelep√≠pedo (ou bloco retangular) tem 6 faces retangulares (ou quadradas, no caso do cubo): base inferior, base superior, e 4 faces laterais.",
                dica_simples: "Lembre-se de contar todas as faces, incluindo a superior e a inferior.",
                ajudar_completa: "O paralelep√≠pedo √© um hexaedro, ou seja, possui 6 faces. Ele √© composto por tr√™s pares de faces id√™nticas: as duas bases e dois pares de faces laterais. Ao planificar, voc√™ deve ter 6 figuras retangulares.",
                exemplo_similar: "Exemplo: Um prisma triangular tem 5 faces (3 retangulares laterais e 2 bases triangulares)."
            },
            { // Adicionada do t√≥pico Rela√ß√£o de Euler
                topic: "Geometria Espacial (Rela√ß√£o de Euler)",
                question: "Em um poliedro, se possui 6 faces e 8 v√©rtices, quantas arestas esse poliedro possui?",
                options: ["6", "12", "10", "8"],
                answerIndex: 1, // B) 12
                explanation: "Usando a Rela√ß√£o de Euler: V - A + F = 2. 8 - A + 6 = 2. 14 - A = 2. A = 12 arestas. (Este √© um cubo).",
                dica_simples: "Use a Rela√ß√£o de Euler: V + F = A + 2.",
                ajudar_completa: "A Rela√ß√£o de Euler (V - A + F = 2) √© a chave. V = 8, F = 6. 8 - A + 6 = 2. 14 - A = 2. A = 12.",
                exemplo_similar: "Exemplo: Um poliedro com 10 v√©rtices e 7 faces tem 15 arestas (10 + 7 = A + 2; A = 17 - 2 = 15)."
            },
            { // Adicionada do t√≥pico Geometria Anal√≠tica
                topic: "Geometria Anal√≠tica (Reta e Ponto)",
                question: "Qual √© a equa√ß√£o da reta que passa pelos pontos (1, 2) e (3, 4)?",
                options: ["y = 2x + 1", "y = x + 1", "y = 2x", "y = 3x - 1"],
                answerIndex: 1, // B) y = x + 1
                explanation: "1. Coeficiente angular (m): m = (4 - 2) / (3 - 1) = 1. 2. Equa√ß√£o (y - y1 = m(x - x1)): y - 2 = 1(x - 1). y = x - 1 + 2. y = x + 1.",
                dica_simples: "Primeiro encontre o coeficiente angular m = (y2 - y1) / (x2 - x1).",
                ajudar_completa: "1. Encontre o coeficiente angular (m): m = (y2 - y1) / (x2 - x1). 2. Use a equa√ß√£o fundamental da reta com um dos pontos: y - y1 = m(x - x1).",
                exemplo_similar: "Exemplo: A reta que passa por (1, 1) e (2, 3) tem m = 2. A equa√ß√£o √© y = 2x - 1."
            }
        ];

        // Perguntas adicionais para o MODO REVIS√ÉO (Expandidas para 6 por t√≥pico)
        // O conte√∫do movido para 'questions' foi removido desta se√ß√£o.
        const reviewQuestionSet = {
            "Geometria Plana (Semelhan√ßa e Trigonometria)": [
                { // P14 do usu√°rio
                    question: "Um engenheiro desenhou um tri√¢ngulo ret√¢ngulo em um projeto. Se o √¢ngulo de 45 graus est√° oposto a um cateto de 10 cm, qual √© a medida do outro cateto?",
                    options: ["10 cm", "5 cm", "7 cm", "8 cm"],
                    answerIndex: 0, 
                    explanation: "Se um √¢ngulo agudo √© de 45 graus, o outro tamb√©m √© (180 - 90 - 45 = 45). Assim, o tri√¢ngulo √© is√≥sceles (dois √¢ngulos iguais), e os catetos opostos aos √¢ngulos de 45 graus s√£o iguais. O outro cateto tamb√©m mede 10 cm.",
                    dica_simples: "Se um tri√¢ngulo ret√¢ngulo tem um √¢ngulo de 45¬∞, ele √© is√≥sceles, o que significa que os catetos s√£o iguais.",
                    ajudar_completa: "Em um tri√¢ngulo, a soma dos √¢ngulos internos √© 180¬∞. Se j√° temos um √¢ngulo de 90¬∞ e um de 45¬∞, o terceiro √¢ngulo √© 45¬∞. Em geometria, lados opostos a √¢ngulos iguais s√£o congruentes. Portanto, os dois catetos opostos aos √¢ngulos de 45¬∞ devem ter o mesmo comprimento.",
                    exemplo_similar: "Exemplo: Se o cateto oposto a 30¬∞ mede 5, o oposto a 60¬∞ mede 5 * raiz(3) e a hipotenusa mede 10."
                },
                { // NOVA PERGUNTA 1 (Criada por mim)
                    question: "Dois hex√°gonos s√£o semelhantes. O per√≠metro do hex√°gono menor √© 30 cm. Se a raz√£o de semelhan√ßa do menor para o maior √© de 1:2, qual √© o per√≠metro do hex√°gono maior?",
                    options: ["30 cm", "60 cm", "45 cm", "90 cm"],
                    answerIndex: 1, 
                    explanation: "A raz√£o entre os per√≠metros de figuras semelhantes √© igual √† raz√£o de semelhan√ßa dos lados. Raz√£o = Per√≠metro menor / Per√≠metro maior. 1/2 = 30 / x. x = 60 cm.",
                    dica_simples: "A raz√£o entre os per√≠metros √© a mesma que a raz√£o entre os lados.",
                    ajudar_completa: "Se a raz√£o de semelhan√ßa entre os lados √© k, a raz√£o entre os per√≠metros tamb√©m √© k. Per√≠metro Maior = Per√≠metro Menor / k. Neste caso: Per√≠metro Maior = 30 / (1/2) = 30 * 2 = 60 cm.",
                    exemplo_similar: "Exemplo: Se a raz√£o entre dois quadrados √© 1/5, e o per√≠metro do menor √© 8 cm, o per√≠metro do maior √© 40 cm (8 * 5)."
                },
                { // NOVA Q4 (Semelhan√ßa)
                    question: "Qual a altura de uma √°rvore que projeta uma sombra de 15m, sabendo que um poste de 4m projeta uma sombra de 5m no mesmo instante?",
                    options: ["10 m", "12 m", "15 m", "16 m"],
                    answerIndex: 1, // 12m (4/5 = x/15 -> 5x = 60 -> x=12)
                    explanation: "Use a semelhan√ßa de tri√¢ngulos formada pela altura e sombra dos objetos. Altura do poste / Sombra do poste = Altura da √°rvore / Sombra da √°rvore. 4/5 = x/15. 5x = 60. x = 12m.",
                    dica_simples: "A propor√ß√£o entre altura e sombra √© a mesma para os dois objetos (poste e √°rvore).",
                    ajudar_completa: "Monte a propor√ß√£o: Altura_poste / Sombra_poste = Altura_arvore / Sombra_arvore. 4/5 = x/15. Para isolar x, multiplique 4 por 15 e divida o resultado por 5. x = 60/5 = 12.",
                    exemplo_similar: "Exemplo: Um homem de 2m projeta 3m de sombra. Uma torre que projeta 9m de sombra tem 6m de altura (2/3 = x/9 -> 3x=18 -> x=6)."
                },
                { // NOVA Q5 (Trigonometria - Tangente)
                    question: "Qual a tangente de um √¢ngulo agudo em um tri√¢ngulo ret√¢ngulo se o cateto oposto a ele mede 8 e o cateto adjacente mede 6?",
                    options: ["4/5", "3/4", "4/3", "5/4"],
                    answerIndex: 2, // 4/3
                    explanation: "Tangente √© a raz√£o entre o Cateto Oposto e o Cateto Adjacente. Tan = Oposto / Adjacente = 8/6. Simplificando, temos 4/3.",
                    dica_simples: "Tangente = Cateto Oposto / Cateto Adjacente.",
                    ajudar_completa: "A Tangente √© uma das tr√™s raz√µes trigonom√©tricas principais (Seno, Cosseno, Tangente). Ela √© definida como a raz√£o entre o comprimento do lado oposto ao √¢ngulo e o comprimento do lado adjacente ao √¢ngulo no tri√¢ngulo ret√¢ngulo. Tan = 8/6 = 4/3.",
                    exemplo_similar: "Exemplo: Se o cateto oposto mede 10 e o adjacente mede 5, a tangente √© 10/5 = 2."
                },
                 { // NOVA Q6 (Trigonometria - Rela√ß√£o Fundamental)
                    question: "Se o seno de um √¢ngulo agudo √© 0.8, qual √© o valor do cosseno desse √¢ngulo em um tri√¢ngulo ret√¢ngulo?",
                    options: ["0.2", "0.4", "0.6", "0.8"],
                    answerIndex: 2, // 0.6
                    explanation: "Use a Rela√ß√£o Fundamental da Trigonometria: sen¬≤(x) + cos¬≤(x) = 1. (0.8)¬≤ + cos¬≤(x) = 1. 0.64 + cos¬≤(x) = 1. cos¬≤(x) = 0.36. cos(x) = 0.6.",
                    dica_simples: "Lembre-se da rela√ß√£o: Sen¬≤ + Cos¬≤ = 1.",
                    ajudar_completa: "A Rela√ß√£o Fundamental da Trigonometria (RFT) √© sempre v√°lida: Seno ao quadrado de um √¢ngulo mais Cosseno ao quadrado do mesmo √¢ngulo √© igual a 1. 0.8¬≤ = 0.64. 1 - 0.64 = 0.36. A raiz quadrada de 0.36 √© 0.6.",
                    exemplo_similar: "Exemplo: O valor do cosseno de 60 graus tamb√©m √© 1/2." // Exemplo corrigido
                }
            ],
            "Geometria Plana (Teorema de Pit√°goras)": [
                { // P11 do usu√°rio
                    question: "Um tri√¢ngulo possui lados de medidas 7 cm, 24 cm e 25 cm. Esse tri√¢ngulo √© ret√¢ngulo? Justifique.",
                    options: ["Sim, porque 7¬≤ + 24¬≤ = 25¬≤.", "N√£o, porque 7¬≤ + 24¬≤ √© diferente de 25¬≤.", "Sim, porque 25¬≤ √© o maior lado.", "N√£o, porque n√£o tem um √¢ngulo reto."],
                    answerIndex: 0, 
                    explanation: "Para ser ret√¢ngulo, deve satisfazer Pit√°goras: 7¬≤ + 24¬≤ = 49 + 576 = 625. E 25¬≤ = 625. Como 625 = 625, √© um tri√¢ngulo ret√¢ngulo.",
                    dica_simples: "Verifique se a soma dos quadrados dos dois menores lados √© igual ao quadrado do maior lado.",
                    ajudar_completa: "O teorema de Pit√°goras tamb√©m serve como condi√ß√£o de exist√™ncia para tri√¢ngulos ret√¢ngulos (teorema rec√≠proco). Se a soma do quadrado dos dois menores lados for igual ao quadrado do maior lado, o tri√¢ngulo √© ret√¢ngulo. Aqui: 49 + 576 = 625. 625 = 625.",
                    exemplo_similar: "Exemplo: Um tri√¢ngulo com lados 2, 3 e 4 n√£o √© ret√¢ngulo, pois 2¬≤ + 3¬≤ = 4 + 9 = 13, e 4¬≤ = 16. Como 13 ‚â† 16, ele n√£o √© ret√¢ngulo."
                },
                { // NOVA PERGUNTA 2 (Usando conceito de escada)
                    question: "Uma escada de 5 metros est√° apoiada em uma parede. Se a base da escada est√° a 3 metros da parede, a que altura (em metros) a escada atinge a parede?",
                    options: ["3 m", "4 m", "5 m", "6 m"],
                    answerIndex: 1, 
                    explanation: "A escada (5m) √© a hipotenusa, a dist√¢ncia da base (3m) √© um cateto. h¬≤ + 3¬≤ = 5¬≤. h¬≤ + 9 = 25. h¬≤ = 16. h = 4 metros.",
                    dica_simples: "A escada forma a hipotenusa do tri√¢ngulo ret√¢ngulo.",
                    ajudar_completa: "Represente a situa√ß√£o como um tri√¢ngulo ret√¢ngulo onde a parede e o ch√£o formam o √¢ngulo de 90¬∞. A escada √© o lado mais longo (hipotenusa = 5). A dist√¢ncia no ch√£o √© um cateto (3). Use Pit√°goras para encontrar o outro cateto (altura): h¬≤ + 3¬≤ = 5¬≤.",
                    exemplo_similar: "Exemplo: Se a escada (hipotenusa) fosse 13m e a base (cateto) fosse 5m, a altura seria 12m, pois 5¬≤ + 12¬≤ = 13¬≤."
                },
                { // NOVA Q4 (Diagonal do quadrado)
                    question: "A diagonal de um quadrado mede 10 cm. Qual √© a medida do lado do quadrado?",
                    options: ["10 / raiz(2) cm", "5 cm", "10 cm", "10 * raiz(2) cm"],
                    answerIndex: 0, // 10 / raiz(2) cm
                    explanation: "A diagonal (d) de um quadrado √© dada por d = L * raiz(2), onde L √© o lado. Se d = 10, ent√£o 10 = L * raiz(2). L = 10 / raiz(2) cm.",
                    dica_simples: "A diagonal divide o quadrado em dois tri√¢ngulos ret√¢ngulos is√≥sceles. Use L¬≤ + L¬≤ = d¬≤.",
                    ajudar_completa: "Use Pit√°goras: L¬≤ + L¬≤ = d¬≤. 2L¬≤ = 100. L¬≤ = 50. L = raiz(50) = 5 * raiz(2). A resposta 10/raiz(2) √© equivalente (racionalizando, 10*raiz(2) / 2 = 5*raiz(2)).",
                    exemplo_similar: "Exemplo: Se o lado do quadrado √© 4 cm, a diagonal √© 4 * raiz(2) cm."
                },
                { // NOVA Q5 (Tri√¢ngulo 60x80)
                    question: "Um campo retangular tem 80m de comprimento e 60m de largura. Qual o comprimento da diagonal (em metros)?",
                    options: ["100 m", "120 m", "140 m", "160 m"],
                    answerIndex: 0, // 100m
                    explanation: "Use Pit√°goras: 60¬≤ + 80¬≤ = d¬≤. 3600 + 6400 = 10000. d = raiz(10000) = 100 metros.",
                    dica_simples: "O comprimento e a largura s√£o catetos. A diagonal √© a hipotenusa.",
                    ajudar_completa: "As dimens√µes do campo (largura e comprimento) s√£o os catetos de um tri√¢ngulo ret√¢ngulo, e a diagonal √© a hipotenusa. Note que 60, 80 e 100 s√£o m√∫ltiplos de 6, 8 e 10, que formam outra terna pitag√≥rica (60¬≤ + 80¬≤ = 100¬≤).",
                    exemplo_similar: "Exemplo: Um ret√¢ngulo 3m por 4m tem uma diagonal de 5m."
                },
                { // NOVA Q6 (Dist√¢ncia Horizontal - Rampa)
                    question: "Uma rampa de acesso tem comprimento (hipotenusa) de 10 metros e atinge uma altura (cateto) de 6 metros. Qual √© a dist√¢ncia horizontal (outro cateto) percorrida?",
                    options: ["8 m", "4 m", "12 m", "16 m"],
                    answerIndex: 0, // 8 m
                    explanation: "Use Pit√°goras: x¬≤ + 6¬≤ = 10¬≤. x¬≤ + 36 = 100. x¬≤ = 64. x = 8 metros.",
                    dica_simples: "Hipotenusa¬≤ - Cateto¬≤ = Cateto¬≤.",
                    ajudar_completa: "O comprimento da rampa √© a hipotenusa (10) e a altura √© um cateto (6). x¬≤ + 6¬≤ = 10¬≤. x¬≤ = 100 - 36. x¬≤ = 64. x = 8.",
                    exemplo_similar: "Exemplo: Se a hipotenusa fosse 17m e o cateto fosse 8m, o outro cateto seria 15m (8, 15, 17 √© uma terna pitag√≥rica)."
                }
            ],
            "Geometria Espacial (Planifica√ß√£o)": [
                { // NOVA PERGUNTA 3 (Criada por mim - Cilindro)
                    question: "A planifica√ß√£o de um cilindro circular reto √© composta por quais figuras geom√©tricas planas?",
                    options: ["Dois c√≠rculos e um ret√¢ngulo.", "Um c√≠rculo e um ret√¢ngulo.", "Tr√™s c√≠rculos.", "Um quadrado e dois c√≠rculos."],
                    answerIndex: 0, // A) Dois c√≠rculos e um ret√¢ngulo.
                    explanation: "A planifica√ß√£o de um cilindro √© composta por duas bases circulares (superior e inferior) e uma superf√≠cie lateral retangular.",
                    dica_simples: "Pense no r√≥tulo de uma lata: ele √© um ret√¢ngulo que envolve os dois c√≠rculos (tampa e fundo).",
                    ajudar_completa: "A superf√≠cie de um cilindro √© formada pela base inferior (c√≠rculo), base superior (c√≠rculo) e pela √°rea lateral. Se voc√™ 'abrir' a √°rea lateral, ela forma um ret√¢ngulo cuja altura √© a altura do cilindro e cuja base √© o comprimento da circunfer√™ncia da base.",
                    exemplo_similar: "Exemplo: A planifica√ß√£o de um cone √© composta por um c√≠rculo (base) e um setor circular (√°rea lateral)."
                },
                { // Planifica√ß√£o de Pir√¢mide
                    question: "A planifica√ß√£o de uma pir√¢mide de base quadrada √© composta por quais formas geom√©tricas?",
                    options: ["Um quadrado e quatro ret√¢ngulos.", "Um quadrado e quatro tri√¢ngulos.", "Seis tri√¢ngulos.", "Um ret√¢ngulo e dois tri√¢ngulos."],
                    answerIndex: 1, // B) Um quadrado e quatro tri√¢ngulos.
                    explanation: "A pir√¢mide de base quadrada tem uma base (um quadrado) e quatro faces laterais (quatro tri√¢ngulos).",
                    dica_simples: "A planifica√ß√£o inclui a base (quadrado) e todas as faces laterais (tri√¢ngulos).",
                    ajudar_completa: "Uma pir√¢mide possui uma √∫nica base e faces laterais triangulares que se encontram no v√©rtice. Se a base √© quadrada, ela √© formada por 1 quadrado e 4 tri√¢ngulos.",
                    exemplo_similar: "Exemplo: Uma pir√¢mide de base triangular (tetraedro) √© composta por 4 tri√¢ngulos (incluindo a base)."
                },
                { // NOVA Q4 (Faces do prisma hexagonal)
                    question: "Quantos ret√¢ngulos s√£o necess√°rios para planificar as faces laterais de um prisma de base hexagonal?",
                    options: ["4", "5", "6", "8"],
                    answerIndex: 2, // 6
                    explanation: "Um hex√°gono tem 6 lados. Um prisma hexagonal tem 6 faces laterais, e todas s√£o retangulares.",
                    dica_simples: "O n√∫mero de faces laterais √© igual ao n√∫mero de lados da base.",
                    ajudar_completa: "Um prisma tem duas bases (neste caso, hex√°gonos) e faces laterais retangulares. O n√∫mero de faces laterais √© sempre igual ao n√∫mero de lados da base. Como a base √© hexagonal (6 lados), s√£o necess√°rios 6 ret√¢ngulos.",
                    exemplo_similar: "Exemplo: Um prisma de base triangular precisa de 3 ret√¢ngulos para as faces laterais."
                },
                { // NOVA Q5 (Planifica√ß√£o do cone)
                    question: "A planifica√ß√£o de um cone circular reto √© composta por um c√≠rculo (base) e uma figura que representa sua lateral. Que figura √© essa?",
                    options: ["Um tri√¢ngulo", "Um ret√¢ngulo", "Um setor circular", "Um semic√≠rculo"],
                    answerIndex: 2, // Setor circular
                    explanation: "A lateral do cone, quando aberta, forma um setor circular (uma fatia) de um c√≠rculo maior, cuja √°rea depende do raio e da geratriz do cone.",
                    dica_simples: "Pense em um chap√©u de anivers√°rio. A parte curva aberta n√£o √© um tri√¢ngulo.",
                    ajudar_completa: "Ao contr√°rio dos prismas e cilindros, cuja lateral √© retangular, a lateral do cone √© curva e c√¥nica. Ao ser planificada, ela se transforma em um setor circular, ou seja, a por√ß√£o de um c√≠rculo delimitada por dois raios e um arco.",
                    exemplo_similar: "Exemplo: A planifica√ß√£o de uma pir√¢mide √© formada por sua base e por tri√¢ngulos laterais."
                },
                { // NOVA Q6 (N√£o planific√°vel)
                    question: "Qual dos seguintes s√≥lidos n√£o possui planifica√ß√£o perfeita em superf√≠cies planas (√© uma superf√≠cie n√£o-desenvolvente)?",
                    options: ["Cubo", "Cilindro", "Cone", "Esfera"],
                    answerIndex: 3, // Esfera
                    explanation: "Cubo, cilindro e cone s√£o superf√≠cies desenvolv√≠veis, ou seja, podem ser abertas em um plano. A esfera √© uma superf√≠cie n√£o-desenvolv√≠vel e, portanto, n√£o pode ser planificada sem distor√ß√£o.",
                    dica_simples: "Qual s√≥lido √© totalmente curvo e sem cantos?",
                    ajudar_completa: "Planifica√ß√£o s√≥ √© poss√≠vel para s√≥lidos que podem ser 'desdobrados' em um plano sem que a √°rea seja alterada. A esfera √© uma superf√≠cie de dupla curvatura, e sua representa√ß√£o plana (como nos mapas) sempre exige distor√ß√£o.",
                    exemplo_similar: "Exemplo: O toro (formato de boia) tamb√©m n√£o √© planific√°vel."
                }
            ],
            "Geometria Espacial (Rela√ß√£o de Euler)": [
                { // P13 do usu√°rio
                    question: "Um poliedro tem 12 arestas e 6 faces. Qual √© o n√∫mero de v√©rtices desse poliedro?",
                    options: ["6", "8", "12", "10"],
                    answerIndex: 1, // B) 8
                    explanation: "Usando a Rela√ß√£o de Euler: V - A + F = 2. V - 12 + 6 = 2. V - 6 = 2. V = 8 v√©rtices.",
                    dica_simples: "A f√≥rmula √© V + F = A + 2. Substitua os valores e resolva para V.",
                    ajudar_completa: "V - A + F = 2. O n√∫mero de arestas (A) √© 12 e o n√∫mero de faces (F) √© 6. V - 12 + 6 = 2. V - 6 = 2. V = 8.",
                    exemplo_similar: "Exemplo: Um poliedro com 7 v√©rtices e 7 faces tem 12 arestas (7 + 7 = A + 2; A = 14 - 2 = 12)."
                },
                { // Prisma Triangular
                    question: "Um poliedro convexo possui 5 faces e 6 v√©rtices. Quantas arestas ele possui?",
                    options: ["9", "10", "11", "7"],
                    answerIndex: 0, // A) 9
                    explanation: "Usando a Rela√ß√£o de Euler: V - A + F = 2. 6 - A + 5 = 2. 11 - A = 2. A = 9 arestas.",
                    dica_simples: "V + F = A + 2.",
                    ajudar_completa: "V = 6 e F = 5. 6 - A + 5 = 2. 11 - A = 2. A = 9. O poliedro √© um prisma triangular.",
                    exemplo_similar: "Exemplo: O octaedro tem 6 v√©rtices e 8 faces, portanto 12 arestas (6 + 8 = A + 2; A = 14 - 2 = 12)."
                },
                { // NOVA Q4 (Dodecaedro - 12 faces)
                    question: "Um dodecaedro (poliedro com 12 faces) tem 20 v√©rtices. Quantas arestas ele possui?",
                    options: ["30", "32", "28", "24"],
                    answerIndex: 0, // 30
                    explanation: "Rela√ß√£o de Euler: V + F = A + 2. 20 (V) + 12 (F) = A + 2. 32 = A + 2. A = 30 arestas.",
                    dica_simples: "Lembre-se: Faces mais V√©rtices √© igual a Arestas mais 2.",
                    ajudar_completa: "Substitua V=20 e F=12 na f√≥rmula V + F = A + 2. 20 + 12 = A + 2. 32 = A + 2. A = 30.",
                    exemplo_similar: "Exemplo: Um icosaedro tem 12 v√©rtices e 20 faces, portanto 30 arestas (12 + 20 = A + 2)."
                },
                { // NOVA Q5 (Prisma base pentagonal)
                    question: "Um prisma com base pentagonal (5 lados) tem 7 faces e 10 v√©rtices. Quantas arestas ele possui?",
                    options: ["12", "14", "15", "18"],
                    answerIndex: 2, // 15
                    explanation: "Rela√ß√£o de Euler: V + F = A + 2. 10 (V) + 7 (F) = A + 2. 17 = A + 2. A = 15 arestas. (Prismas de base n t√™m 2n v√©rtices, n+2 faces e 3n arestas).",
                    dica_simples: "Lembre-se da f√≥rmula para poliedros convexos.",
                    ajudar_completa: "V = 10, F = 7. 10 + 7 = A + 2. 17 = A + 2. A = 15.",
                    exemplo_similar: "Exemplo: Uma base triangular tem 6 V, 5 F e 9 A."
                },
                { // NOVA Q6 (Pir√¢mide base triangular - Tetraedro)
                    question: "Uma pir√¢mide de base triangular (tetraedro) tem 4 faces e 4 v√©rtices. Quantas arestas esse poliedro possui?",
                    options: ["4", "5", "6", "8"],
                    answerIndex: 2, // 6
                    explanation: "Rela√ß√£o de Euler: V + F = A + 2. 4 (V) + 4 (F) = A + 2. 8 = A + 2. A = 6 arestas.",
                    dica_simples: "Um tetraedro √© o poliedro mais simples: 4 faces, 4 v√©rtices.",
                    ajudar_completa: "O tetraedro √© um dos s√≥lidos plat√¥nicos. Seus valores s√£o 4 V√©rtices, 4 Faces e 6 Arestas. 4 + 4 = 6 + 2.",
                    exemplo_similar: "Exemplo: Uma pir√¢mide de base quadrada tem 5 V, 5 F e 8 A."
                }
            ],
            "Geometria Anal√≠tica (Reta e Ponto)": [
                { // P12 do usu√°rio
                    question: "A equa√ß√£o da reta gerada pelos pontos (2, 3) e (4, 7) √©?",
                    options: ["y = 2x ‚Äì 1", "y = 2x + 2", "y = 3x ‚Äì 3", "y = 2x + 1"],
                    answerIndex: 0, // A) y = 2x - 1
                    explanation: "1. Coeficiente angular (m): m = (7 - 3) / (4 - 2) = 2. 2. Equa√ß√£o: y - 3 = 2(x - 2). y = 2x - 4 + 3. y = 2x - 1.",
                    dica_simples: "O coeficiente angular √© 2. Use a f√≥rmula da reta para descobrir o coeficiente linear 'b'.",
                    ajudar_completa: "1. Encontre m: m = (7 - 3) / (4 - 2) = 2. 2. Use o ponto (2, 3) na equa√ß√£o reduzida y = mx + b: 3 = 2(2) + b. 3 = 4 + b. b = -1. Equa√ß√£o final: y = 2x - 1.",
                    exemplo_similar: "Exemplo: A reta com m=3 que passa por (0, 5) tem equa√ß√£o y = 3x + 5."
                },
                { // NOVA PERGUNTA 4 (Criada por mim - Coeficiente angular)
                    question: "Qual √© o coeficiente angular (declividade) da reta representada pela equa√ß√£o y = 5x + 3?",
                    options: ["5", "-3", "3", "2"],
                    answerIndex: 0, // A) 5
                    explanation: "Em uma equa√ß√£o reduzida da reta (y = mx + b), o coeficiente angular (declividade) √© o valor 'm', que acompanha o x. Neste caso, m = 5.",
                    dica_simples: "Em y = mx + b, 'm' √© o coeficiente angular.",
                    ajudar_completa: "A equa√ß√£o y = mx + b √© a forma reduzida da equa√ß√£o da reta. O termo 'm' √© o coeficiente angular e representa a inclina√ß√£o ou declividade da reta, enquanto 'b' √© o coeficiente linear (onde a reta corta o eixo y).",
                    exemplo_similar: "Exemplo: Na equa√ß√£o y = -2x + 7, o coeficiente angular √© -2, indicando uma reta decrescente."
                },
                { // NOVA Q4 (Dist√¢ncia entre dois pontos)
                    question: "Qual √© a dist√¢ncia exata entre os pontos A(2, 0) e B(5, 4)?",
                    options: ["3", "4", "5", "raiz(13)"],
                    answerIndex: 2, // 5
                    explanation: "Use a f√≥rmula da dist√¢ncia: d = raiz((x2 - x1)¬≤ + (y2 - y1)¬≤). d = raiz((5 - 2)¬≤ + (4 - 0)¬≤). d = raiz(3¬≤ + 4¬≤). d = raiz(25) = 5.",
                    dica_simples: "Use o Teorema de Pit√°goras para calcular a hipotenusa formada pela diferen√ßa das coordenadas.",
                    ajudar_completa: "A dist√¢ncia entre dois pontos no plano cartesiano √© calculada como a hipotenusa de um tri√¢ngulo ret√¢ngulo imagin√°rio cujos catetos s√£o a diferen√ßa horizontal (delta x) e a diferen√ßa vertical (delta y). Dist√¢ncia = raiz((5-2)¬≤ + (4-0)¬≤) = 5.",
                    exemplo_similar: "Exemplo: A dist√¢ncia entre (0, 0) e (6, 8) √© 10."
                },
                { // NOVA Q5 (Equa√ß√£o de reta paralela ao eixo x)
                    question: "Uma reta √© paralela ao eixo x e passa pelo ponto (3, 5). Qual √© a sua equa√ß√£o?",
                    options: ["x = 3", "y = 5", "y = x + 2", "y = 3x + 5"],
                    answerIndex: 1, // y = 5
                    explanation: "Retas paralelas ao eixo x (horizontal) t√™m o coeficiente angular m = 0. A equa√ß√£o √© sempre y = k, onde k √© a coordenada y do ponto. Como passa por (3, 5), a equa√ß√£o √© y = 5.",
                    dica_simples: "Reta horizontal (paralela ao eixo x) significa que o valor de y √© constante.",
                    ajudar_completa: "Se a reta √© paralela ao eixo x, todos os pontos da reta t√™m a mesma coordenada y. O ponto fornecido √© (3, 5), ent√£o y deve ser sempre 5. Se fosse paralela ao eixo y (vertical), a equa√ß√£o seria x = k.",
                    exemplo_similar: "Exemplo: A reta paralela ao eixo x que passa por (-1, -4) √© y = -4."
                },
                { // NOVA Q6 (Coeficiente linear)
                    question: "O coeficiente linear da reta 2x + y = 6 √©:",
                    options: ["2", "6", "-2", "3"],
                    answerIndex: 1, // 6
                    explanation: "Para encontrar o coeficiente linear (b), isole y na equa√ß√£o (forma reduzida y = mx + b). y = -2x + 6. O coeficiente linear √© o termo independente, que √© 6.",
                    dica_simples: "Isole Y para encontrar a forma reduzida da equa√ß√£o (y = mx + b).",
                    ajudar_completa: "O coeficiente linear √© o valor onde a reta intercepta o eixo y. Ele √© o termo 'b' na forma reduzida y = mx + b. Ao isolar y na equa√ß√£o 2x + y = 6, obtemos y = -2x + 6. O valor de b √© 6.",
                    exemplo_similar: "Exemplo: Na equa√ß√£o y = 3x - 10, o coeficiente linear √© -10."
                }
            ]
        };
        
        // ====================================================================
        // VARI√ÅVEIS DE ESTADO GLOBAIS (MOVIDAS PARA O TOPO PARA GARANTIR DEFINI√á√ÉO)
        // ====================================================================
        const REVIEW_EXIT_PASSWORD = '1234'; // SENHA FIXA
        let weakestTopicName = ''; 
        let quizMode = 'main'; // 'main' ou 'review'
        let reviewQuestions = [];
        let reviewIndex = -1;
        let reviewCorrectCount = 0; 
        let quizCompletedSuccessfully = false; // NOVO: Flag para acerto total no quiz principal
        
        let lifelineUsage = { ajudar: false, dica: false, exemplo: false };
        let secondChanceActive = false; 

        let topicPerformance = {
            "Geometria Plana (Semelhan√ßa e Trigonometria)": { total: 0, correct: 0, wrong: 0 },
            "Geometria Plana (Teorema de Pit√°goras)": { total: 0, correct: 0, wrong: 0 },
            "Geometria Espacial (Planifica√ß√£o)": { total: 0, correct: 0, wrong: 0 },
            "Geometria Espacial (Rela√ß√£o de Euler)": { total: 0, correct: 0, wrong: 0 },
            "Geometria Anal√≠tica (Reta e Ponto)": { total: 0, correct: 0, wrong: 0 }
        };

        let currentQuestionIndex = -1; 
        let currentScore = 0;
        let consecutiveCorrect = 0;
        let timerInterval;
        let timeLeft = 0; 
        let quizActive = false;
        
        // NOVO CRON√îMETRO PROGRESSIVO
        let totalTimeSeconds = 0; 
        let progressiveTimerInterval;

        // NOVO: Armazenamento de dados do usu√°rio
        let userName = ''; 
        let userClass = ''; 

        // FIREBASE VARS
        let db, auth;
        let appId;
        let userId;

        // NOVO: DECLARA√á√ÉO DE VARI√ÅVEIS DE REFER√äNCIA DO DOM
        let startScreenEl, mainQuizContainerEl, startActionBtn, questionTextEl, topicInfoEl, optionsContainerEl, nextQuestionBtn, reviewBtn, restartBtn, retryBtn, ajudarBtn, dicaBtn, exemploBtn, progressiveTimerDisplayEl, currentScoreEl, consecutiveCorrectEl, quizBoxEl, messageBoxEl, userNameInputEl, userClassInputEl, startErrorEl, rankingBtn;
        
        // ====================================================================

        // Novo: Fun√ß√£o para formatar o tempo em H:M:S
        function formatTime(totalSeconds) {
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;

            const pad = (num) => String(num).padStart(2, '0');
            return `${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;
        }
        
        // Novo: Fun√ß√£o para iniciar o cron√¥metro progressivo
        function startProgressiveTimer() {
            clearInterval(progressiveTimerInterval);
            
            progressiveTimerInterval = setInterval(() => {
                totalTimeSeconds++;
                if (progressiveTimerDisplayEl) {
                    progressiveTimerDisplayEl.textContent = formatTime(totalTimeSeconds);
                }
            }, 1000);
        }

        // Novo: Fun√ß√£o para parar o cron√¥metro progressivo
        function stopProgressiveTimer() {
            clearInterval(progressiveTimerInterval);
        }

        // --- FUN√á√ïES FIREBASE (ADICIONADAS) ---

        async function setupFirebase() {
            setLogLevel('Debug');
            const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
            appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            
            if (Object.keys(firebaseConfig).length === 0) {
                console.warn("Firebase config n√£o encontrada. A classifica√ß√£o estar√° desabilitada.");
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Autentica√ß√£o
                if (typeof __initial_auth_token !== 'undefined') {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                userId = auth.currentUser?.uid || `anon-${Math.random().toString(36).substring(2, 9)}`;
                console.log("Firebase e autentica√ß√£o configurados. User ID:", userId);

            } catch (error) {
                console.error("Erro ao configurar o Firebase ou autenticar:", error);
            }
        }

        async function saveResultToFirestore() {
            if (!db || !appId) {
                console.warn("Firestore n√£o inicializado. N√£o foi poss√≠vel salvar o resultado.");
                return;
            }
            
            const resultsCollectionPath = `artifacts/${appId}/public/data/quiz_results`;

            try {
                const resultData = {
                    name: userName,
                    class: userClass,
                    score: currentScore,
                    time: totalTimeSeconds, // Armazena em segundos para desempate
                    timestamp: new Date().toISOString()
                };

                await addDoc(collection(db, resultsCollectionPath), resultData);
                console.log("Resultado salvo com sucesso!");

            } catch (error) {
                console.error("Erro ao salvar resultado no Firestore:", error);
                alertUser("ERRO NO BANCO DE DADOS", "N√£o foi poss√≠vel salvar seu resultado na classifica√ß√£o.");
            }
        }

        async function loadRanking() {
            if (!db || !appId) {
                 alertUser("ERRO", "Classifica√ß√£o desabilitada (Firebase n√£o configurado).");
                 return [];
            }
            
            const resultsCollectionPath = `artifacts/${appId}/public/data/quiz_results`;

            try {
                // Consulta: Busca todos os documentos na cole√ß√£o (sem limit)
                const q = query(
                    collection(db, resultsCollectionPath)
                    // Removendo a ordena√ß√£o para evitar o erro de √≠ndice
                );

                const querySnapshot = await getDocs(q);
                let ranking = [];

                querySnapshot.forEach((doc) => {
                    ranking.push(doc.data());
                });

                // CLASSIFICA√á√ÉO LOCAL NO JAVASCRIPT: Ordena por Score (DESC) e depois por Time (ASC)
                ranking.sort((a, b) => {
                    // 1. Ordena por Score (Maior primeiro)
                    if (b.score !== a.score) {
                        return b.score - a.score;
                    }
                    // 2. Desempate por Tempo (Menor primeiro)
                    return a.time - b.time;
                });
                
                // REMOVIDO O LIMITE DE 10 PARA MOSTRAR TODOS
                // ranking = ranking.slice(0, 10); 

                showRankingModal(ranking);
                return ranking;

            } catch (error) {
                console.error("Erro ao carregar o ranking:", error);
                alertUser("ERRO DE CLASSIFICA√á√ÉO", "N√£o foi poss√≠vel carregar a classifica√ß√£o. Detalhe: " + error.message);
                return [];
            }
        }

        function showRankingModal(rankingData) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4';
            
            let tableContent = `
                <table class="ranking-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Nome (Turma)</th>
                            <th>Pontos</th>
                            <th>Tempo</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            if (rankingData.length === 0) {
                tableContent += `<tr><td colspan="4" class="text-center text-gray-900">Nenhum resultado ainda. Seja o primeiro!</td></tr>`;
            } else {
                rankingData.forEach((result, index) => {
                    tableContent += `
                        <tr class="${index < 3 ? 'bg-yellow-100 font-bold' : (index % 2 === 0 ? 'bg-gray-50' : 'bg-white') }">
                            <td class="text-gray-900">${index + 1}</td>
                            <td class="text-gray-900">${result.name} (${result.class})</td>
                            <td class="text-gray-900">${result.score}</td>
                            <td class="text-gray-900 font-mono">${formatTime(result.time)}</td>
                        </tr>
                    `;
                });
            }

            tableContent += `</tbody></table>`;

            modal.innerHTML = `
                <div class="bg-white p-8 rounded-lg text-gray-900 max-w-xl w-full shadow-2xl">
                    <h3 class="text-2xl font-bold mb-4 text-center">CLASSIFICA√á√ÉO GERAL - TODOS OS PARTICIPANTES</h3>
                    ${tableContent}
                    <p class="mt-4 text-sm text-gray-600 text-center">Mostrando todos os ${rankingData.length} resultados. Ordenado por Pontos (maior) e Tempo (menor).</p>
                    <button id="close-ranking-modal" class="w-full mt-6 bg-blue-600 text-white p-2 rounded font-semibold hover:bg-blue-700">FECHAR</button>
                </div>
            `;
            document.body.appendChild(modal);
            document.getElementById('close-ranking-modal').addEventListener('click', () => {
                document.body.removeChild(modal);
            });
        }
        
        // --- FIM DAS FUN√á√ïES FIREBASE ---

        // Fun√ß√£o auxiliar para selecionar N perguntas aleat√≥rias de um t√≥pico
        function selectRandomQuestions(topicName, count) {
            const allQuestions = reviewQuestionSet[topicName];
            if (!allQuestions || allQuestions.length < count) {
                console.error(`N√£o h√° quest√µes suficientes para o t√≥pico ${topicName}`);
                return [];
            }
            
            // Cria uma c√≥pia e embaralha (Fisher-Yates)
            let shuffled = [...allQuestions];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            
            // Retorna as primeiras 'count' quest√µes
            return shuffled.slice(0, count);
        }

        // FUN√á√ÉO CENTRAL: Inicia o ciclo de revis√£o
        function startReviewAttempt(topic) {
            weakestTopicName = topic;
            quizMode = 'review';
            reviewIndex = -1;
            reviewCorrectCount = 0;
            
            // NOVO: Seleciona um novo subconjunto de 3 perguntas
            reviewQuestions = selectRandomQuestions(weakestTopicName, 3);
            
            // Oculta/Mostra bot√µes
            reviewBtn.classList.add('hidden');
            retryBtn.classList.add('hidden'); // Esconde o bot√£o de tentar novamente
            nextQuestionBtn.classList.remove('hidden');
            restartBtn.classList.add('hidden'); 
            
            // Zera a sequ√™ncia do quiz principal (se necess√°rio)
            consecutiveCorrect = 0;
            updateScore();
            
            // Reinicia o uso de linhas de vida (habilitadas no modo revis√£o)
            lifelineUsage = { ajudar: false, dica: false, exemplo: false };
            
            startProgressiveTimer(); // ADICIONADO: Garante que o cron√¥metro continue/recomece na revis√£o.
            loadNextQuestion();
        }

        // --- Fun√ß√µes Principais do Quiz (Resto do c√≥digo mantido) ---
        
        // Fun√ß√£o unificada para exibir o pop-up de ajuda
        function alertHelp(title, message) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white p-8 rounded-lg text-gray-900 max-w-sm w-full shadow-2xl">
                    <h3 class="text-xl font-bold mb-4">${title}</h3>
                    <p class="mb-6">${message}</p>
                    <button id="close-modal" class="w-full bg-blue-600 text-white p-2 rounded font-semibold hover:bg-blue-700">FECHAR</button>
                </div>
            `;
            document.body.appendChild(modal);
            document.getElementById('close-modal').addEventListener('click', () => {
                document.body.removeChild(modal);
            });
        }
        
        // Fun√ß√£o para atualizar o placar
        function updateScore() {
            currentScoreEl.textContent = currentScore;
            consecutiveCorrectEl.textContent = consecutiveCorrect;
        }

        // Fun√ß√£o para atualizar o estado dos bot√µes de ajuda
        function updateLifelineButtons() {
            // Se n√£o estiver ativo (resposta dada), desabilita TUDO.
            if (!quizActive) { 
                ajudarBtn.disabled = true;
                dicaBtn.disabled = true;
                exemploBtn.disabled = true;
                return;
            }
            
            // NOVO: No modo revis√£o, as ajudas s√£o SEMPRE ativas (se o quiz estiver ativo).
            if (quizMode === 'review') {
                ajudarBtn.disabled = false;
                dicaBtn.disabled = false;
                exemploBtn.disabled = false;
                return;
            }

            // MODO PRINCIPAL (Main): Desabilita se j√° foi usado.
            ajudarBtn.disabled = lifelineUsage.ajudar;
            dicaBtn.disabled = lifelineUsage.dica;
            exemploBtn.disabled = lifelineUsage.exemplo;
        }

        // A√ß√£o de tempo esgotado (MANUALMENTE REMOVIDA)
        function handleTimeOut() {
            // Esta fun√ß√£o n√£o √© mais chamada ou necess√°ria, pois o tempo foi removido.
        }

        // FUN√á√ÉO CENTRAL: Carrega a pr√≥xima pergunta, ou o relat√≥rio final
        function loadNextQuestion() {
            messageBoxEl.classList.add('hidden');
            
            // Resetar estados por pergunta
            secondChanceActive = false; 

            if (quizMode === 'main') {
                currentQuestionIndex++;
                if (currentQuestionIndex >= questions.length) {
                    // FIM DO QUIZ PRINCIPAL: Mostrar relat√≥rio
                    showFinalReport();
                    return;
                }
                
                const currentQ = questions[currentQuestionIndex];
                // Numera√ß√£o principal no formato "1 - "
                document.getElementById('quiz-title').textContent = `Pergunta ${currentQuestionIndex + 1}:`;
                questionTextEl.textContent = `${currentQuestionIndex + 1} - ${currentQ.question}`;
                topicInfoEl.innerHTML = `Conte√∫do: ${currentQ.topic}`;
                
            } else if (quizMode === 'review') {
                reviewIndex++;
                if (reviewIndex >= reviewQuestions.length) {
                    // FIM DO MODO REVIS√ÉO
                    showReviewEnd();
                    return;
                }
                
                const currentQ = reviewQuestions[reviewIndex];
                // Numera√ß√£o de revis√£o sem '/'
                document.getElementById('quiz-title').textContent = `REVIS√ÉO ${reviewIndex + 1}:`;
                questionTextEl.textContent = `${currentQ.question}`;
                topicInfoEl.innerHTML = `REVISANDO: ${currentQ.topic}`;
            }

            // L√≥gica comum de carregamento
            let currentSet = quizMode === 'main' ? questions : reviewQuestions;
            let currentIndex = quizMode === 'main' ? currentQuestionIndex : reviewIndex;
            const currentQ = currentSet[currentIndex];

            quizActive = true;
            quizBoxEl.classList.add('main-quiz-box');
            quizBoxEl.classList.remove('bg-green-700', 'bg-red-700', 'bg-gray-800');
            
            nextQuestionBtn.disabled = true;
            nextQuestionBtn.textContent = "RESPONDENDO...";

            optionsContainerEl.innerHTML = '';
            currentQ.options.forEach((option, index) => {
                const button = document.createElement('button');
                button.className = 'option-button p-4 rounded-lg text-left font-semibold shadow-md';
                button.textContent = String.fromCharCode(65 + index) + ") " + option; // A) B) C) D)
                button.dataset.index = index;
                button.addEventListener('click', handleAnswer);
                optionsContainerEl.appendChild(button);
            });

            updateLifelineButtons();
            // startTimer(); // REMOVIDO: N√£o inicia mais o timer
        }

        // Fun√ß√£o para desabilitar as op√ß√µes ap√≥s uma resposta
        function disableOptions(correctIndex, selectedIndex = -1) {
            const options = optionsContainerEl.querySelectorAll('.option-button');
            options.forEach((button, index) => {
                button.disabled = true;
                if (index === correctIndex) {
                    button.classList.add('correct-answer');
                    button.classList.remove('option-button');
                } else if (index === selectedIndex) {
                    button.classList.add('wrong-answer');
                    button.classList.remove('option-button');
                }
            });
        }

        // Fun√ß√£o de tratamento de resposta (MOSTRA A EXPLICA√á√ÉO CLARAMENTE COM NUMERA√á√ÉO)
        function handleAnswer(event) {
            if (!quizActive) return;

            
            const selectedButton = event.currentTarget;
            const selectedIndex = parseInt(selectedButton.dataset.index);
            
            let currentSet = quizMode === 'main' ? questions : reviewQuestions;
            let currentIndex = quizMode === 'main' ? currentQuestionIndex : reviewIndex;
            const currentQ = currentSet[currentIndex];
            const correctIndex = currentQ.answerIndex;
            
            // Tratamento da Segunda Chance (Convidados) - MANTIDO A L√ìGICA CASO O BOT√ÉO SEJA REINTRODUZIDO
            if (selectedIndex !== correctIndex && secondChanceActive) {
                secondChanceActive = false; // Consome a chance
                selectedButton.disabled = true;
                selectedButton.classList.add('eliminated-option');
                
                alertHelp("CONVIDADOS", "Resposta incorreta! Voc√™ tem uma segunda chance. Escolha outra op√ß√£o.");
                return; // N√ÉO finaliza a quest√£o, apenas desabilita a op√ß√£o errada
            }
            
            // Se chegou aqui, a quest√£o est√° sendo FINALIZADA (acerto, erro sem 2¬™ chance, ou 2¬∫ erro)
            
            nextQuestionBtn.disabled = false;
            updateLifelineButtons(); // Desabilita linhas de vida

            quizActive = false;
            
            disableOptions(correctIndex, selectedIndex);
            
            let questionNumber = quizMode === 'main' ? currentIndex + 1 : currentIndex + 1; // Simplificado

            if (selectedIndex === correctIndex) {
                // Acerto
                if (quizMode === 'main') {
                    // CADA ACERTO VALE 1 PONTO
                    currentScore += 1;
                    consecutiveCorrect++;
                    topicPerformance[currentQ.topic].total++;
                    topicPerformance[currentQ.topic].correct++;
                } else if (quizMode === 'review') { 
                    reviewCorrectCount++;
                }

                quizBoxEl.classList.remove('main-quiz-box', 'bg-red-700');
                quizBoxEl.classList.add('bg-green-700');
                // Mensagem de acerto ajustada
                questionTextEl.textContent = (quizMode === 'main' ? "CORRETO! Voc√™ ganhou 1 ponto!" : "CORRETO!");
                
                // Numera√ß√£o no formato "1 - "
                messageBoxEl.textContent = `${questionNumber} - ACERTO / EXPLICA√á√ÉO: ${currentQ.explanation}`;
                messageBoxEl.classList.remove('hidden', 'bg-red-600');
                messageBoxEl.classList.add('bg-green-600');
            } else {
                // Erro (Final)
                if (quizMode === 'main') {
                    consecutiveCorrect = 0;
                    topicPerformance[currentQ.topic].total++;
                    topicPerformance[currentQ.topic].wrong++;
                }
                
                quizBoxEl.classList.remove('main-quiz-box', 'bg-green-700');
                quizBoxEl.classList.add('bg-red-700');
                questionTextEl.textContent = "ERRADO! A resposta correta era: " + currentQ.options[correctIndex];
                
                // Numera√ß√£o no formato "1 - "
                messageBoxEl.textContent = `${questionNumber} - ERRO / EXPLICA√á√ÉO: ${currentQ.explanation}`; 
                messageBoxEl.classList.remove('hidden', 'bg-green-600');
                messageBoxEl.classList.add('bg-red-600');
            }
            
            updateScore();
            
            // Atualiza o texto do bot√£o para o pr√≥ximo passo (seja pr√≥xima pergunta ou resultado final)
            if (quizMode === 'main' && currentQuestionIndex === questions.length - 1) {
                nextQuestionBtn.textContent = "VER RESULTADO FINAL";
            } else if (quizMode === 'review' && reviewIndex === reviewQuestions.length - 1) {
                nextQuestionBtn.textContent = "FIM DA REVIS√ÉO";
            } else {
                 nextQuestionBtn.textContent = "PR√ìXIMA PERGUNTA";
            }
        }
        
        // Novo: Encontra o t√≥pico com mais erros
        function findWeakestTopic() {
            let maxErrors = -1;
            let weakestTopic = null;
            let totalQuestionsAnswered = 0;

            for (const topic in topicPerformance) {
                totalQuestionsAnswered += topicPerformance[topic].total;
                if (topicPerformance[topic].wrong > maxErrors) {
                    maxErrors = topicPerformance[topic].wrong;
                    weakestTopic = topic;
                }
            }
            // Retorna o t√≥pico fraco apenas se houver pelo menos 1 erro.
            return maxErrors > 0 ? weakestTopic : null; 
        }

        // Novo: Exibe o relat√≥rio final do quiz principal
        function showFinalReport() {
            stopProgressiveTimer(); // PARAR O CRON√îMETRO
            const weakestTopic = findWeakestTopic();
            
            optionsContainerEl.innerHTML = '';
            nextQuestionBtn.classList.add('hidden');
            retryBtn.classList.add('hidden'); // Oculta o bot√£o de repeti√ß√£o

            const finalTime = formatTime(totalTimeSeconds); // Obter tempo final

            let reportMessage = `
                <h2 class="text-2xl font-bold mb-4">RELAT√ìRIO FINAL</h2>
                <!-- PONTUA√á√ÉO AJUSTADA AQUI -->
                <p class="text-xl font-semibold mb-2">JOGADOR: <span class="text-yellow-300">${userName} (${userClass})</span></p>
                <p class="text-xl font-semibold mb-2">PONTUA√á√ÉO TOTAL: <span class="text-yellow-300">${currentScore}</span> PONTO(S)</p>
                <p class="text-lg font-semibold mt-4">TEMPO GASTO TOTAL: <span class="text-yellow-300 font-mono">${finalTime}</span></p>
            `;

            if (weakestTopic) {
                quizCompletedSuccessfully = false; // Teve erros, n√£o completou com sucesso
                weakestTopicName = weakestTopic; // Salva o t√≥pico fraco para a fun√ß√£o de repeti√ß√£o
                
                const errors = topicPerformance[weakestTopic].wrong;
                
                reportMessage += `
                    <div class="mt-4 p-4 rounded-lg bg-red-700">
                        <h3 class="text-lg font-bold">üéØ FOCO NA REVIS√ÉO</h3>
                        <p class="mt-2 text-xl font-mono">${weakestTopic}</p>
                        <p class="mt-1 text-sm">VOC√ä COMETEU ${errors} ERRO${errors > 1 ? 'S' : ''} NESTE TEMA.</p>
                    </div>
                    <p class="mt-4 text-base">√â OBRIGAT√ìRIO CONCLUIR A REVIS√ÉO PARA JOGAR NOVAMENTE.</p>
                `;
                reviewBtn.textContent = `INICIAR REVIS√ÉO: ${weakestTopic.split('(')[0].trim()}`;
                reviewBtn.classList.remove('hidden'); // Mostra o bot√£o de revis√£o

                // NOVO: Bot√£o REINICIAR (SAIR E REINICIAR) DESABILITADO
                restartBtn.textContent = 'SAIR E REINICIAR';
                restartBtn.disabled = true;
                restartBtn.classList.add('opacity-50', 'cursor-not-allowed');
                restartBtn.classList.remove('hidden');

            } else {
                // SUCESSO NO QUIZ PRINCIPAL
                quizCompletedSuccessfully = true; 
                saveResultToFirestore(); // SALVA O RESULTADO
                reportMessage += `
                    <div class="mt-4 p-4 rounded-lg bg-green-700">
                        <h3 class="text-lg font-bold">üåü PARAB√âNS!</h3>
                        <p class="mt-2">VOC√ä ACERTOU TODAS AS QUEST√ïES. JOGUE NOVAMENTE PARA CONSOLIDAR SEU CONHECIMENTO!</p>
                    </div>
                `;
                reviewBtn.classList.add('hidden'); // Oculta o bot√£o se n√£o houver erro claro

                // ALTERADO: Bot√£o FINAL AGORA √â "SAIR DO JOGO"
                restartBtn.textContent = 'SAIR DO JOGO';
                restartBtn.disabled = false;
                restartBtn.classList.remove('opacity-50', 'cursor-not-allowed', 'hidden');
            }

            quizBoxEl.classList.remove('main-quiz-box', 'bg-green-700', 'bg-red-700');
            quizBoxEl.classList.add('bg-gray-800');
            questionTextEl.innerHTML = reportMessage;
            topicInfoEl.textContent = "AN√ÅLISE CONCLU√çDA.";
            updateLifelineButtons(); // Desabilita linhas de vida no relat√≥rio
            quizActive = false;
        }
        
        // Exibe o fim do modo revis√£o, mostrando a quantidade de acertos
        function showReviewEnd() {
            quizBoxEl.classList.remove('bg-green-700', 'bg-red-700');
            optionsContainerEl.innerHTML = '';
            nextQuestionBtn.classList.add('hidden');
            reviewBtn.classList.add('hidden');
            
            const totalReview = reviewQuestions.length;
            const finalTime = formatTime(totalTimeSeconds); // Obter tempo final
            let timeDisplay = `<p class="text-lg font-semibold mt-4">TEMPO TOTAL DA ATIVIDADE: <span class="text-yellow-300 font-mono">${finalTime}</span></p>`;


            if (reviewCorrectCount === totalReview) {
                stopProgressiveTimer(); // PARAR CRON√îMETRO APENAS NO SUCESSO
                saveResultToFirestore(); // SALVA O RESULTADO AP√ìS REVIS√ÉO COMPLETA
                // SUCESSO! Acertou todas as 3
                quizBoxEl.classList.add('bg-green-700');
                 questionTextEl.innerHTML = `
                    <h2 class="text-2xl font-bold mb-4">REVIS√ÉO CONCLU√çDA COM SUCESSO!</h2>
                    <p class="text-xl font-semibold mb-2">ACERTOS: <span class="text-yellow-300">${reviewCorrectCount} / ${totalReview}</span></p>
                    <p class="mt-4">VOC√ä DOMINOU O T√ìPICO ${weakestTopicName.split('(')[0].trim()}. AGORA PODE REINICIAR O QUIZ.</p>
                    ${timeDisplay}
                `;
                // ALTERADO: Bot√£o FINAL AGORA √â "SAIR DO JOGO"
                restartBtn.textContent = 'SAIR DO JOGO';
                restartBtn.disabled = false;
                restartBtn.classList.remove('hidden', 'opacity-50', 'cursor-not-allowed');
                retryBtn.classList.add('hidden');
            } else {
                // FALHA! Precisa tentar novamente (O cron√¥metro continua rodando)
                quizBoxEl.classList.add('bg-red-700');
                 questionTextEl.innerHTML = `
                    <h2 class="text-2xl font-bold mb-4">REVIS√ÉO INCOMPLETA!</h2>
                    <p class="text-xl font-semibold mb-2">ACERTOS: <span class="text-yellow-300">${reviewCorrectCount} / ${totalReview}</span></p>
                    <p class="mt-4">PARA CONCLUIR O CICLO, VOC√ä PRECISA DE ${totalReview}/${totalReview} ACERTOS. TENTE NOVAMENTE COM NOVAS PERGUNTAS!</p>
                `;
                retryBtn.classList.remove('hidden'); // MOSTRA O BOT√ÉO TENTAR NOVAMENTE
                restartBtn.classList.add('hidden'); 
            }
            
            topicInfoEl.textContent = "FIM DA REVIS√ÉO";
            updateLifelineButtons(); // Desabilita linhas de vida
            quizActive = false;
        }
        
        // NOVO: Fun√ß√£o para iniciar o jogo (sai da tela inicial)
        function startGame() {
            // Captura e valida√ß√£o dos dados
            userName = userNameInputEl.value.trim();
            userClass = userClassInputEl.value.trim();

            if (!userName || !userClass) {
                startErrorEl.classList.remove('hidden');
                return; 
            }
            startErrorEl.classList.add('hidden');

            startScreenEl.classList.add('hidden');
            mainQuizContainerEl.classList.remove('hidden');
            nextQuestionBtn.classList.remove('hidden');
            
            startProgressiveTimer(); // INICIA O CRON√îMETRO
            
            loadNextQuestion(); // Inicia o quiz com a primeira pergunta
        }

        // NOVO: Fun√ß√£o central que realiza o reset de estado e DOM.
        function forceFullReset(skipStartScreen = false) { 
            // Zera todas as vari√°veis de estado
            currentQuestionIndex = -1; 
            currentScore = 0;
            consecutiveCorrect = 0;
            quizMode = 'main';
            reviewIndex = -1;
            reviewCorrectCount = 0;
            weakestTopicName = '';
            quizCompletedSuccessfully = false; 
            
            // ZERA O TEMPO E O CRON√îMETRO
            stopProgressiveTimer();
            totalTimeSeconds = 0;
            if (progressiveTimerDisplayEl) {
                progressiveTimerDisplayEl.textContent = formatTime(totalTimeSeconds);
            }

            // ZERA O USO DOS RECURSOS
            lifelineUsage = { ajudar: false, dica: false, exemplo: false };
            secondChanceActive = false; 

            // Zera o desempenho dos t√≥picos
            for (const topic in topicPerformance) {
                 topicPerformance[topic] = { total: 0, correct: 0, wrong: 0 };
            }

            // Oculta bot√µes de fim de jogo e limpa DOM
            reviewBtn.classList.add('hidden');
            restartBtn.classList.add('hidden');
            retryBtn.classList.add('hidden');
            nextQuestionBtn.classList.add('hidden');
            optionsContainerEl.innerHTML = ''; 
            messageBoxEl.classList.add('hidden'); 
            
            // Resetar a apar√™ncia da caixa de pergunta
            quizBoxEl.classList.remove('bg-green-700', 'bg-red-700', 'bg-gray-800');
            quizBoxEl.classList.add('main-quiz-box');
            document.getElementById('quiz-title').textContent = 'Pergunta';
            questionTextEl.textContent = 'Aguardando Carregamento...';
            topicInfoEl.textContent = 'Conte√∫do: ';

            // Limpa os campos de input do usu√°rio
            if (userNameInputEl) userNameInputEl.value = '';
            if (userClassInputEl) userClassInputEl.value = '';
            
            // Retorna √† tela inicial ou inicia o jogo
            if (skipStartScreen) {
                startGame(); // Vai direto para a Pergunta 1
            } else {
                initializeQuiz(); // Volta para a tela de A√á√ÉO
            }
        }
        
        // Fun√ß√£o de Reiniciar (chamada pelo bot√£o)
        function restartQuiz() {
            // Verifica se o bot√£o REINICIAR est√° habilitado (caso contr√°rio, ignora o clique)
            if (restartBtn.disabled) return;
            
            // Chama a fun√ß√£o central de reset (volta para a tela inicial)
            forceFullReset();
        }

        // --- NOVO: Fun√ß√µes de Controle de Sa√≠da e Senha ---

        function exitReviewMode() {
            // FIX: Garante que forceFullReset volte para a Tela Inicial (Start Screen)
            forceFullReset(); 
        }

        function showPasswordModal() {
            stopProgressiveTimer(); // PAUSA O CRON√îMETRO AO ABRIR O MODAL

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white p-8 rounded-lg text-gray-900 max-w-sm w-full shadow-2xl text-center">
                    <h3 class="text-xl font-bold mb-4">CONFIRMA√á√ÉO DE SA√çDA</h3>
                    <p class="mb-4">Para sair do modo Revis√£o, digite a senha de 4 d√≠gitos:</p>
                    <input type="password" id="password-input" maxlength="4" class="w-full p-2 border border-gray-400 rounded mb-4 text-center text-lg tracking-widest font-mono focus:outline-none focus:ring-2 focus:ring-red-600">
                    <p id="password-error" class="text-red-600 mb-4 hidden">Senha incorreta. Tente novamente.</p>
                    <div class="flex justify-between gap-2">
                        <button id="confirm-password" class="w-1/2 bg-red-600 text-white p-2 rounded font-semibold hover:bg-red-700">CONFIRMAR</button>
                        <button id="cancel-password" class="w-1/2 bg-gray-400 text-gray-800 p-2 rounded font-semibold hover:bg-gray-500">CANCELAR</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            const passwordInput = document.getElementById('password-input');
            const errorEl = document.getElementById('password-error');

            document.getElementById('cancel-password').addEventListener('click', () => {
                document.body.removeChild(modal);
                // Retoma √† revis√£o e retoma o cron√¥metro
                if (quizMode === 'review') { 
                    startProgressiveTimer(); 
                }
            });

            document.getElementById('confirm-password').addEventListener('click', () => {
                const inputPassword = passwordInput.value;

                if (inputPassword === REVIEW_EXIT_PASSWORD) {
                    document.body.removeChild(modal);
                    exitReviewMode(); // CHAMA o RESET COMPLETO E VOLTA PARA A TELA INICIAL
                } else {
                    errorEl.classList.remove('hidden');
                    passwordInput.value = ''; // Limpa o input em caso de falha
                    passwordInput.focus();
                }
            });

            // Permite submiss√£o com a tecla Enter
            passwordInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('confirm-password').click();
                }
            });

            passwordInput.focus();
        }

        function handleParar() {
            stopProgressiveTimer(); // PAUSA O CRON√îMETRO
            const currentTime = formatTime(totalTimeSeconds);

            if (quizMode === 'review') {
                // Se estiver em revis√£o, exige a senha para sair
                showPasswordModal();
            } else {
                // Modo principal: pausa simples. Ao fechar o modal, o timer deve ser retomado.
                const modalTitle = "JOGO PARADO";
                const modalMessage = `VOC√ä PAROU. Tempo decorrido: ${currentTime}. CLIQUE EM PR√ìXIMA PERGUNTA PARA CONTINUAR.`;
                
                // Usa a fun√ß√£o auxiliar de modal
                alertHelp(modalTitle, modalMessage);
            }
        }
        // --- FIM das Fun√ß√µes de Controle de Sa√≠da e Senha ---

        // NOVO: Fun√ß√£o para atribuir as refer√™ncias DOM
        function setupDOMReferences() {
             startScreenEl = document.getElementById('start-screen');
             mainQuizContainerEl = document.getElementById('main-quiz-container');
             startActionBtn = document.getElementById('start-action-btn');

             // Novos Inputs
             userNameInputEl = document.getElementById('user-name-input');
             userClassInputEl = document.getElementById('user-class-input');
             startErrorEl = document.getElementById('start-error-message');

             questionTextEl = document.getElementById('question-text');
             topicInfoEl = document.getElementById('topic-info');
             optionsContainerEl = document.getElementById('options-container');
             nextQuestionBtn = document.getElementById('next-question-btn');
             reviewBtn = document.getElementById('review-btn'); 
             restartBtn = document.getElementById('restart-btn'); 
             retryBtn = document.getElementById('retry-btn'); 

             ajudarBtn = document.getElementById('ajudar-btn'); 
             dicaBtn = document.getElementById('dica-btn'); 
             exemploBtn = document.getElementById('exemplo-btn'); 
             rankingBtn = document.getElementById('ranking-btn');
            
             // ATUALIZADO: Usando o novo ID para o display do tempo progressivo
             progressiveTimerDisplayEl = document.getElementById('progressive-timer-display');
             currentScoreEl = document.getElementById('current-score');
             consecutiveCorrectEl = document.getElementById('consecutive-correct');
             quizBoxEl = document.getElementById('quiz-box');
             messageBoxEl = document.getElementById('message-box');
        }

        // --- FUN√á√ïES HANDLERS MOVIDAS PARA GARANTIR DEFINI√á√ÉO SEQUENCIAL ---

        // NOVO HANDLER: Ajuda Completa (Como fazer)
        function handleAjudar() {
            // A verifica√ß√£o de uso s√≥ ocorre no quiz principal
            if (!quizActive || (quizMode === 'main' && lifelineUsage.ajudar)) return;
            
            let currentSet = quizMode === 'main' ? questions : reviewQuestions;
            let currentIndex = quizMode === 'main' ? currentQuestionIndex : reviewIndex;
            const currentQ = currentSet[currentIndex];
            
            if (currentQ && currentQ.ajudar_completa) {
                alertHelp("AJUDAR (COMO FAZER)", currentQ.ajudar_completa);
                
                // Marca como usado SOMENTE se estiver no modo principal
                if (quizMode === 'main') {
                    lifelineUsage.ajudar = true;
                }
                updateLifelineButtons();
            }
        }
        
        // NOVO HANDLER: Dica Simples
        function handleDica() {
            // A verifica√ß√£o de uso s√≥ ocorre no quiz principal
            if (!quizActive || (quizMode === 'main' && lifelineUsage.dica)) return;
            
            let currentSet = quizMode === 'main' ? questions : reviewQuestions;
            let currentIndex = quizMode === 'main' ? currentQuestionIndex : reviewIndex;
            const currentQ = currentSet[currentIndex];
            
            if (currentQ && currentQ.dica_simples) {
                alertHelp("DICA", currentQ.dica_simples);
                
                // Marca como usado SOMENTE se estiver no modo principal
                if (quizMode === 'main') {
                    lifelineUsage.dica = true;
                }
                updateLifelineButtons();
            }
        }

        // NOVO HANDLER: Exemplo Similar
        function handleExemplo() {
            // A verifica√ß√£o de uso s√≥ ocorre no quiz principal
            if (!quizActive || (quizMode === 'main' && lifelineUsage.exemplo)) return;
            
            let currentSet = quizMode === 'main' ? questions : reviewQuestions;
            let currentIndex = quizMode === 'main' ? currentQuestionIndex : reviewIndex;
            const currentQ = currentSet[currentIndex];
            
            if (currentQ && currentQ.exemplo_similar) {
                alertHelp("EXEMPLO SIMILAR", currentQ.exemplo_similar);
                
                // Marca como usado SOMENTE se estiver no modo principal
                if (quizMode === 'main') {
                    lifelineUsage.exemplo = true;
                }
                updateLifelineButtons();
            }
        }
        
        // Fun√ß√£o de alerta (substituindo o alert() padr√£o)
        function alertUser(title, message) {
            alertHelp(title, message);
        }
        
        // Inicializa√ß√£o
        function initializeQuiz() {
             setupDOMReferences(); // NOVO: Inicializa as refer√™ncias DOM aqui
             setupFirebase(); // NOVO: Inicializa o Firebase
             
             // Estado inicial: Main quiz container hidden, start screen shown
            mainQuizContainerEl.classList.add('hidden');
            startScreenEl.classList.remove('hidden');

            updateScore();
            progressiveTimerDisplayEl.textContent = formatTime(0); // Zera e exibe o cron√¥metro
            updateLifelineButtons(); // Desabilita bot√µes no in√≠cio
            
            // ATRIBUI√á√ÉO DE LISTENERS (Movidos para dentro da initializeQuiz)
            startActionBtn.addEventListener('click', startGame);

            nextQuestionBtn.addEventListener('click', () => {
                 if (!nextQuestionBtn.disabled) {
                    // Retoma o cron√¥metro se estiver pausado
                    if (!quizActive) {
                        startProgressiveTimer();
                    }
                    loadNextQuestion();
                }
            });
            
            // NOVO: Chama a fun√ß√£o handleParar()
            document.getElementById('parar-btn').addEventListener('click', handleParar);
            rankingBtn.addEventListener('click', loadRanking); // NOVO: Listener para o ranking

            restartBtn.addEventListener('click', restartQuiz);
            retryBtn.addEventListener('click', () => startReviewAttempt(weakestTopicName));
            
            ajudarBtn.addEventListener('click', handleAjudar);
            dicaBtn.addEventListener('click', handleDica);
            exemploBtn.addEventListener('click', handleExemplo);

            reviewBtn.addEventListener('click', () => startReviewAttempt(weakestTopicName));
        }

        initializeQuiz();
    </script>
</body>
</html>
