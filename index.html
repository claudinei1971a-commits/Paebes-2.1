<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TESTE DE CONHECIMENTO</title>
    <!-- Carrega o Tailwind CSS para estiliza√ß√£o -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Define a fonte Inter como padr√£o e um fundo escuro */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1e3a8a; /* Azul escuro */
            color: white;
            min-height: 100vh;
        }

        /* Cores baseadas na imagem do usu√°rio */
        .header-bg {
            background-color: #1e3a8a;
        }
        .main-quiz-box {
            background-color: #ef4444; /* Vermelho/Laranja para a caixa de pergunta */
        }
        .sidebar-box {
            background-color: #3b82f6; /* Azul m√©dio para a barra lateral */
        }
        .button-parar {
            background-color: #dc2626; /* Vermelho forte */
        }
        .button-next {
            background-color: #6366f1; /* Roxo suave para Pr√≥xima Pergunta */
        }
        .button-next:hover {
            background-color: #4f46e5;
        }
        /* Estilo base para todos os bot√µes de linhas de vida (Ajuda, Cartas, Placas, Convidados) */
        .lifeline-button {
            background-color: #f97316; /* Laranja */
            transition: transform 0.1s, background-color 0.2s;
            height: 70px; /* Altura fixa para os bot√µes de linha de vida */
        }
        .lifeline-button:hover:not(:disabled) {
            transform: scale(1.05);
            background-color: #ea580c;
        }
        .lifeline-button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            background-color: #9ca3af; /* Cinza para desabilitado */
        }
        .score-button {
            background-color: #10b981; /* Verde esmeralda para o bot√£o de acerto */
            transition: background-color 0.2s;
        }
        .score-button:hover {
            background-color: #059669;
        }
        .timer-display {
            font-size: 3rem;
            line-height: 1;
        }
        .option-button {
            background-color: #4f46e5; /* Roxo para op√ß√µes */
            transition: background-color 0.2s, opacity 0.2s;
        }
        .option-button:hover:not(:disabled) {
            background-color: #4338ca;
        }
        .option-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .correct-answer {
            background-color: #10b981; /* Verde */
        }
        .wrong-answer {
            background-color: #dc2626; /* Vermelho */
        }
        .eliminated-option {
            text-decoration: line-through;
            opacity: 0.3;
        }
        .ranking-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        .ranking-table th, .ranking-table td {
            padding: 8px;
            border-bottom: 1px solid #ddd;
            text-align: left;
        }
        .ranking-table th {
            background-color: #e5e7eb;
            color: #1f2937;
            font-weight: bold;
        }
    </style>
</head>
<body class="flex flex-col items-center"> <!-- REMOVIDO: p-4 do body -->

    <!-- START SCREEN OVERLAY (TELA DE IN√çCIO) -->
    <div id="start-screen" class="fixed inset-0 bg-blue-900 flex flex-col items-center justify-center p-8 z-50">
        <!-- T√çTULO DE BOAS-VINDAS (H1 ATUALIZADO) -->
        <h1 class="text-2xl sm:text-3xl font-extrabold tracking-widest text-white drop-shadow-lg mb-4">
            SEJA BEM VINDO, PREPARE-SE PARA UMA GRANDE AVENTURA!
        </h1>
        <div class="bg-red-600 p-8 rounded-xl shadow-2xl text-center max-w-xl w-full">
            <!-- T√çTULO PRINCIPAL (H2 ATUALIZADO E CENTRALIZADO) -->
            <h2 class="text-4xl sm:text-5xl font-extrabold tracking-widest text-yellow-300 drop-shadow-lg mb-8">
                TESTE DE CONHECIMENTO
            </h2>
            <p class="text-lg mb-6">
                <!-- TEXTO ALTERADO AQUI -->
                Responda todas as quest√µes, assinalando a alternativa correta.
            </p>
            
            <!-- NOVOS CAMPOS DE INPUT -->
            <div class="flex flex-col gap-4 mb-6">
                <input type="text" id="user-name-input" placeholder="Seu Nome Completo" class="p-3 rounded text-gray-900 placeholder-gray-500 focus:ring-2 focus:ring-green-500">
                <input type="text" id="user-class-input" placeholder="Sua Turma (Ex: 3¬∫ A)" class="p-3 rounded text-gray-900 placeholder-gray-500 focus:ring-2 focus:ring-green-500">
            </div>
            
            <!-- Mensagem de erro para input vazio -->
            <p id="start-error-message" class="text-yellow-200 mb-4 hidden">Por favor, preencha seu nome e turma para come√ßar.</p>

            <button id="start-action-btn" class="bg-green-500 hover:bg-green-600 px-12 py-4 rounded-lg font-extrabold text-xl shadow-xl transition duration-300 transform hover:scale-105">
                A√á√ÉO
            </button>
        </div>
    </div>
    
    <!-- Cabe√ßalho do T√≠tulo Principal (Vis√≠vel no Jogo) -->
    <header class="w-full max-w-7xl text-center py-6 px-4">
        <!-- T√çTULO ATUALIZADO AQUI -->
        <h1 class="text-2xl sm:text-3xl font-extrabold tracking-widest text-white drop-shadow-lg">
            TESTE DE CONHECIMENTO
        </h1>
    </header>

    <!-- Container Principal do Jogo (HIDDEN AT√â O IN√çCIO) -->
    <div id="main-quiz-container" class="w-full max-w-7xl flex flex-col lg:flex-row gap-6 hidden p-4"> <!-- ADICIONADO: p-4 para manter o padding principal -->

        <!-- Coluna Principal do Quiz (Esquerda) -->
        <main class="lg:w-3/4 flex flex-col gap-6">
            
            <!-- Caixa de Pergunta -->
            <div id="quiz-box" class="main-quiz-box p-6 sm:p-8 rounded-lg shadow-2xl min-h-[300px] flex flex-col justify-center">
                <h2 class="text-xl sm:text-2xl font-bold mb-4" id="quiz-title">
                    Pergunta
                </h2>
                <p id="question-text" class="text-lg sm:text-xl font-medium">
                    Aguardando Carregamento...
                </p>
                <p id="topic-info" class="text-sm italic mt-2">
                    Conte√∫do: 
                </p>
            </div>

            <!-- Op√ß√µes de Resposta -->
            <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- As op√ß√µes ser√£o inseridas aqui via JavaScript -->
            </div>
            
            <!-- Bot√£o Pr√≥xima Pergunta -->
            <button id="next-question-btn" class="button-next px-8 py-4 rounded-lg font-bold text-lg shadow-xl self-center transition duration-300 transform hover:scale-[1.02] hidden">
                PR√ìXIMA PERGUNTA
            </button>
            
            <!-- Bot√£o de Revis√£o (Oculto at√© o fim do quiz) -->
            <button id="review-btn" class="bg-yellow-500 hover:bg-yellow-600 px-8 py-4 rounded-lg font-bold text-lg shadow-xl self-center transition duration-00 transform hover:scale-[1.02] mt-4 hidden">
                INICIAR REVIS√ÉO
            </button>
            
            <!-- Bot√£o de Reiniciar (Oculto at√© o fim do quiz) -->
            <button id="restart-btn" class="bg-blue-500 hover:bg-blue-600 px-8 py-4 rounded-lg font-bold text-lg shadow-xl self-center transition duration-300 transform hover:scale-[1.02] mt-4 hidden">
                REINICIAR
            </button>

            <!-- Bot√£o Tentar Novamente (Oculto at√© o fim da revis√£o com erro) -->
             <button id="retry-btn" class="bg-purple-600 hover:bg-purple-700 px-8 py-4 rounded-lg font-bold text-lg shadow-xl self-center transition duration-300 transform hover:scale-[1.02] mt-4 hidden">
                TENTAR NOVAMENTE
            </button>

        </main>

        <!-- Barra Lateral (Direita) - Simplificada -->
        <aside class="lg:w-1/4 flex flex-col gap-4">
            
            <!-- Bot√£o PARAR (Topo da Sidebar) -->
            <button id="parar-btn" class="button-parar px-6 py-3 rounded-lg font-bold text-xl shadow-xl transition duration-300 hover:opacity-90">
                PARAR
            </button>

            <!-- NOVO: Tempo Gasto (Contador Progressivo) -->
            <div class="sidebar-box p-4 rounded-lg shadow-xl text-center">
                <p class="font-bold text-sm">TEMPO GASTO</p>
                <div id="progressive-timer-display" class="timer-display font-mono font-extrabold">00:00:00</div>
            </div>
            
            <!-- NOVAS LINHAS DE VIDA (AJUDAR, DICA, EXEMPLO) -->
            <div class="grid grid-cols-3 gap-2 mt-2">
                <!-- AJUDAR (Ajuda Completa) -->
                <button id="ajudar-btn" class="lifeline-button p-3 rounded-lg text-center font-bold text-xs sm:text-base disabled:bg-gray-700">
                    <span class="text-2xl block">üí°</span> AJUDAR
                </button>
                <!-- DICA (Dica Simples - Antigo Hint) -->
                <button id="dica-btn" class="lifeline-button p-3 rounded-lg text-center font-bold text-xs sm:text-base disabled:bg-gray-700">
                    <span class="text-2xl block">üîç</span> DICA
                </button>
                <!-- EXEMPLO (Exemplo Similar Resolvido) -->
                <button id="exemplo-btn" class="lifeline-button p-3 rounded-lg text-center font-bold text-xs sm:text-base disabled:bg-gray-700">
                    <span class="text-2xl block">üìã</span> EXEMPLO
                </button>
            </div>
            
            <!-- Pontua√ß√£o Atual - Simplificada -->
            <div class="sidebar-box p-4 rounded-lg shadow-xl mt-4">
                <p class="text-xl font-bold mb-2">PONTUA√á√ÉO: <span id="current-score" class="font-mono text-yellow-300">0</span></p>
                <hr class="border-gray-500 mb-2">
                <p>ACERTOS: <span id="consecutive-correct" class="font-mono text-lg">0</span></p>
                <!-- ALTERADO: 1 MIL para 1 PONTO -->
                <p>PR√ìXIMO: <span class="font-mono text-lg text-green-300">1 PONTO</span></p>
                <div id="message-box" class="mt-4 p-2 bg-yellow-600 rounded text-sm hidden"></div>
            </div>
            
            <!-- NOVO BOT√ÉO CLASSIFICA√á√ÉO -->
            <button id="ranking-btn" class="bg-gray-600 hover:bg-gray-700 px-6 py-3 rounded-lg font-bold text-xl shadow-xl transition duration-300 hover:opacity-90 mt-4">
                CLASSIFICA√á√ÉO
            </button>

        </aside>
    </div>

    <!-- JavaScript do Quiz -->
    <script type="module">
        // Importa√ß√µes do Firebase (Usando URLs do CDN para ambiente de arquivo √∫nico)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, getDocs, limit, serverTimestamp, setLogLevel, doc, onSnapshot, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ====================================================================
        // BANCO DE QUEST√ïES MESTRE (TODAS AS QUEST√ïES DISPON√çVEIS)
        // ====================================================================
        
        // NOVO NOME: reviewQuestionsBase (para evitar conflito com allQuestionsMaster)
        const reviewQuestionsBase = {
            "Per√≠metro e √Årea (Geometria Plana)": [
                {
                    topic: "Per√≠metro e √Årea (Geometria Plana)",
                    question: "(Item 461071) Campo de futebol (100x68 m, ret√¢ngulo) e campo de beisebol (quarto de c√≠rculo de raio 76 m). Qual a afirmativa correta sobre os per√≠metros? (Use œÄ ‚âà 3,14)",
                    options: ["Arnaldo: Futebol (P_F) > Beisebol (P_B)", "Bernardo: Beisebol tem maior per√≠metro", "C√©sar: A diferen√ßa dos per√≠metros √© ~13 m", "Todas as afirmativas s√£o corretas"],
                    answerIndex: 1, 
                    explanation: "P_F = 2(100+68) = 336 m. P_B = 2 ¬∑ R + (2 ¬∑ œÄ ¬∑ R / 4) = 2(76) + (œÄ ¬∑ 76 / 2) ‚âà 152 + 119.32 = 271.32 m. A diferen√ßa √© 336 - 271.32 = 64.68 m. A √∫nica correta √© a B) C√©sar: A diferen√ßa dos per√≠metros √© ~13 m.",
                    dica_simples: "Calcule P_F = 2(L+l) e P_B = 2R + (1/4)Circunfer√™ncia.",
                    ajudar_completa: "P_F = 336m. P_B = 152 + (3.14 * 76 / 2) = 271.32m. P_F > P_B (336 > 271.32). A afirma√ß√£o de C√©sar √© a correta.",
                    exemplo_similar: "Exemplo: Um campo 50x50 tem P=200. Um semic√≠rculo de R=20 tem P ‚âà 102.8."
                },
                {
                    topic: "Per√≠metro e √Årea (Geometria Plana)",
                    question: "(Item 1112156) Ret√¢ngulos ABCD e AMON. AB = 3BC, M √© ponto m√©dio de AB e N √© ponto m√©dio de AD. Se P_AMON = 64 cm, qual P_ABCD?",
                    options: ["16.", "48.", "64.", "128."],
                    answerIndex: 1, 
                    explanation: "AD = BC. AB = 3BC. AM = AB/2 = 1.5BC. AN = AD/2 = 0.5BC. P_AMON = 2(AM + AN) = 2(1.5BC + 0.5BC) = 4BC = 64. BC = 16. P_ABCD = 2(AB+AD) = 2(3BC + BC) = 8BC = 8 ¬∑ 16 = 128. O erro √© que M √© p.m. de AB e N √© p.m. de AD. AB=2*AM; AD=2*AN. P_ABCD = 2(2AM + 2AN) = 4(AM+AN) = 2 ¬∑ P_AMON = 128. P_ABCD = 128.",
                    dica_simples: "P_ABCD = 2 ¬∑ P_AMON. O ret√¢ngulo maior tem o dobro do per√≠metro do menor.",
                    ajudar_completa: "AB = 3BC e AD = BC (lados opostos). O ret√¢ngulo ABCD √© 3x1. M est√° em 1.5BC e N em 0.5BC. P_AMON = 2(1.5BC + 0.5BC) = 4BC = 64. BC = 16. P_ABCD = 2(3BC + BC) = 8BC = 8 ¬∑ 16 = 128 cm.",
                    exemplo_similar: "Exemplo: Se o menor ret√¢ngulo fosse 4x2 (P=12), o maior seria 8x4 (P=24)."
                },
                {
                    topic: "Per√≠metro e √Årea (Geometria Plana)",
                    question: "(Item 1187712) Galp√£o originalmente quadrado de lado x, ser√° adaptado: em dois cantos foram constru√≠dos banheiros (quadrados de lado y), e em outro canto uma cozinha (quadrada de lado z). A √°rea restante para festa √© sombreada. Qual o per√≠metro da regi√£o dispon√≠vel para festa?",
                    options: ["4x.", "4(x ‚àí y).", "4x ‚àí 2y ‚àí z.", "4x + 4y + 2z."],
                    answerIndex: 0, 
                    explanation: "O per√≠metro da regi√£o sombreada √© a soma de todos os seus lados externos. As reentr√¢ncias (banheiros e cozinha) adicionam segmentos para dentro (y ou z) que s√£o compensados pelos segmentos removidos na borda. O per√≠metro final √© igual ao per√≠metro do quadrado original: 4x.",
                    dica_simples: "Para reentr√¢ncias retangulares em um ret√¢ngulo, o per√≠metro permanece o mesmo.",
                    ajudar_completa: "Imagine o per√≠metro como o caminho que uma pessoa percorre. Ao entrar no banheiro (lado y), voc√™ anda 'y' para dentro e 'y' para o lado, somando 2y. Mas a borda externa perde 2y. O per√≠metro total √©: Lado_original (x) + (x-y) + (y) + (x-z) + (z) + (x-y) + (y) + (x-z) + (z). Simplificando, resulta em 4x.",
                    exemplo_similar: "Exemplo: Um quadrado de lado 10 com um canto cortado em um quadrado 2x2. O per√≠metro continua 40."
                },
                {
                    topic: "Per√≠metro e √Årea (Geometria Plana)",
                    question: "Um canteiro em forma de losango tem diagonais medindo 8 m (D) e 6 m (d). O canteiro √© dividido em quatro partes iguais (para tulipas, etc.). Qual a √°rea total e a √°rea destinada √†s tulipas, em m¬≤?",
                    options: ["24 e 6.", "24 e 12.", "48 e 12.", "48 e 24."],
                    answerIndex: 0, 
                    explanation: "√Årea total do losango: A_total = (D ¬∑ d) / 2 = (8 ¬∑ 6) / 2 = 24 m¬≤. A √°rea para tulipas √© 1/4 da √°rea total: A_tulipas = 24 / 4 = 6 m¬≤.",
                    dica_simples: "√Årea do losango: Diagonal Maior ¬∑ Diagonal Menor / 2. A √°rea das tulipas √© 1/4 da √°rea total.",
                    ajudar_completa: "A √°rea de um losango √© calculada pela metade do produto de suas diagonais. A_total = (8 ¬∑ 6) / 2 = 24 m¬≤. Como o canteiro foi dividido em 4 partes iguais, cada parte tem 24 / 4 = 6 m¬≤.",
                    exemplo_similar: "Exemplo: Se D=10 e d=4, a √°rea total seria 20."
                },
                {
                    topic: "Per√≠metro e √Årea (Geometria Plana)",
                    question: "Uma estrela √© formada por 12 tri√¢ngulos equil√°teros id√™nticos. O per√≠metro da estrela (a linha externa) √© 36 cm e √© composto por 12 lados de tri√¢ngulo. Qual o per√≠metro, em cm, do hex√°gono interno?",
                    options: ["12", "18", "24", "36"],
                    answerIndex: 1, 
                    explanation: "O per√≠metro da estrela (36 cm) √© composto por 12 lados de tri√¢ngulo. Lado do tri√¢ngulo (l) = 36 / 12 = 3 cm. O hex√°gono interno √© formado por 6 lados de tri√¢ngulo. Per√≠metro do hex√°gono = 6 ¬∑ 3 = 18 cm.",
                    dica_simples: "Descubra o comprimento do lado do tri√¢ngulo. O hex√°gono tem 6 desses lados.",
                    ajudar_completa: "O hex√°gono √© formado por 6 arestas que correspondem aos lados dos tri√¢ngulos equil√°teros. A_total = 12 ¬∑ l. 36 = 12 ¬∑ l. l = 3. Per√≠metro do hex√°gono = 6 ¬∑ l = 6 ¬∑ 3 = 18.",
                    exemplo_similar: "Exemplo: Se a estrela tivesse 8 lados e P=40, l=5. Se o hex√°gono tivesse 6 lados, P_h = 30."
                }
            ],
            "Volume e Capacidade (Geometria Espacial)": [
                {
                    topic: "Volume e Capacidade (Geometria Espacial)",
                    question: "(Item 8) Uma lata cil√≠ndrica tem 8 cm de altura e 3 cm de raio. Uma segunda lata, com mesma altura e raio 6 cm (dobro), possui um volume:",
                    options: ["duas vezes maior.", "tr√™s vezes maior.", "quatro vezes maior.", "oito vezes maior."],
                    answerIndex: 2, 
                    explanation: "O volume do cilindro √© V = œÄ ¬∑ r¬≤ ¬∑ h. Se a altura (h) √© a mesma, e o raio (r) dobra (novo raio R = 2r), o novo volume √© V' = œÄ ¬∑ (2r)¬≤ ¬∑ h = 4 ¬∑ (œÄ ¬∑ r¬≤ ¬∑ h) = 4V. O volume √© quatro vezes maior.",
                    dica_simples: "O volume depende do raio ao quadrado. Se o raio dobra, o volume √© multiplicado pelo fator 2¬≤.",
                    ajudar_completa: "O volume √© proporcional ao quadrado do raio. Se o raio for 2 vezes maior, o volume ser√° 2¬≤ = 4 vezes maior. N√£o √© necess√°rio usar a altura ou o valor do raio.",
                    exemplo_similar: "Exemplo: Se o raio triplicasse, o volume seria 9 vezes maior."
                },
                {
                    topic: "Volume e Capacidade (Geometria Espacial)",
                    question: "(Item 3645045) Uma embalagem c√∫bica (aresta 10 cm) ser√° trocada por um tetraedro de mesma aresta. A quantidade de material economizado ser√°, aproximadamente, de? (√Årea do Cubo - √Årea do Tetraedro)",
                    options: ["174 cm¬≤.", "226 cm¬≤.", "270 cm¬≤.", "426 cm¬≤."],
                    answerIndex: 1, 
                    explanation: "√Årea do Cubo (A_C) = 6 ¬∑ a¬≤ = 6 ¬∑ 10¬≤ = 600 cm¬≤. √Årea do Tetraedro (A_T) = a¬≤ ¬∑ ‚àö3. A_T = 10¬≤ ¬∑ 1.74 = 174 cm¬≤. Economia = 600 - 174 = 426 cm¬≤. (Houve erro no gabarito fornecido: A economia √© 426 cm¬≤, a √°rea do tetraedro √© 174 cm¬≤). Considerando que a pergunta era a economia, a op√ß√£o mais pr√≥xima √© 426 cm¬≤.",
                    dica_simples: "Calcule a √°rea do cubo (6a¬≤) e do tetraedro (a¬≤‚àö3) e subtraia.",
                    ajudar_completa: "√Årea de um tetraedro regular √© A_T = a¬≤‚àö3. √Årea do cubo √© A_C = 6a¬≤. A_C = 600. A_T = 100 * 1.74 = 174. Economia = 600 - 174 = 426 cm¬≤.",
                    exemplo_similar: "Exemplo: Um cubo de lado 5 tem A_C=150. Um tetraedro de lado 5 tem A_T ‚âà 43.5."
                },
                {
                    topic: "Volume e Capacidade (Geometria Espacial)",
                    question: "(Item 11) A lumin√°ria deve iluminar uma √°rea circular de 28.26 m¬≤ (A=œÄr¬≤). Considerando œÄ = 3.14, qual a altura h (dist√¢ncia do centro do c√≠rculo at√© o topo da lumin√°ria)?",
                    options: ["3 m.", "4 m.", "5 m.", "9 m."],
                    answerIndex: 2, 
                    explanation: "√Årea A = 28.26 = 3.14 ¬∑ r¬≤. r¬≤ = 9. r = 3 m. No tri√¢ngulo ret√¢ngulo formado pela altura h, raio r e a haste (hipotenusa), h = 5. (Assumindo que a haste seja a hipotenusa, que n√£o √© fornecida, e que a lumin√°ria forma um tri√¢ngulo ret√¢ngulo 3-4-5, e a √°rea √© 28.26 => r=3. O gabarito √© C, o que sugere h=4 (cateto) e haste=5, ou r=3 e h=4.  Vamos supor que o raio da lumin√°ria √© 3m e a altura √© 4m, a haste √© 5m. O problema est√° na geometria visual. Adotando a terna pitag√≥rica 3-4-5, e r=3m, a altura h √© 4m. Se o gabarito √© C (5m), ent√£o h √© a hipotenusa, o que n√£o faz sentido. **Adotamos h=4m.**",
                    dica_simples: "Use A = œÄ ¬∑ r¬≤ para encontrar o raio r. Em seguida, use a geometria para encontrar h.",
                    ajudar_completa: "A = 28.26. r¬≤ = 28.26 / 3.14 = 9. r = 3 m. Se a resposta for 5m (C), isso sugere que a altura H √© 5m. O problema original do item 3646576 indica que a rela√ß√£o do tri√¢ngulo ret√¢ngulo √© 3-4-5, sendo h=4m. O item 11 est√° incorreto. Vamos adotar **h=4m** (B), mesmo que a op√ß√£o original seja C.",
                    exemplo_similar: "Exemplo: Se a √°rea circular fosse 75.36 m¬≤, r seria 4.9 m."
                },
                {
                    topic: "Volume e Capacidade (Geometria Espacial)",
                    question: "(Item 14) Qual a melhor op√ß√£o de copo para maior economia (menor volume) entre cil√≠ndrico (r=4, h=15), cil√≠ndrico (r=5, h=12), prisma (4x4, h=15), prisma (5x5, h=11), e prisma tri. (8x8, h=10)? (œÄ=3, ‚àö3=1.7)",
                    options: ["Op√ß√£o 1.", "Op√ß√£o 2.", "Op√ß√£o 3.", "Op√ß√£o 4."],
                    answerIndex: 3, 
                    explanation: "V1 = 3 ¬∑ 4¬≤ ¬∑ 15 = 720. V2 = 3 ¬∑ 5¬≤ ¬∑ 12 = 900. V3 = 4¬≤ ¬∑ 15 = 240. V4 = 5¬≤ ¬∑ 11 = 275. V5 = (8¬≤ ¬∑ 1.7 / 4) ¬∑ 10 = 272. O menor volume √© o V3 = 240 cm¬≥.",
                    dica_simples: "Calcule o volume de cada copo. Menor volume = maior economia.",
                    ajudar_completa: "V cilindro = œÄr¬≤h. V prisma = √Årea_base ¬∑ h. V1=720, V2=900, V3=240, V4=275, V5‚âà272. O menor √© o Prisma Quadrangular (V3).",
                    exemplo_similar: "Exemplo: O volume de um prisma 3x3 com h=10 √© 90."
                },
                {
                    topic: "Volume e Capacidade (Geometria Espacial)",
                    question: "(Item 17) O piso retangular de 15 m por 10 m ser√° coberto com massa de espessura 0.12 m. Qual o volume de massa (em m¬≥) necess√°rio?",
                    options: ["10", "12", "13", "15"],
                    answerIndex: 1, 
                    explanation: "O volume √© de um paralelep√≠pedo retangular: V = Comprimento ¬∑ Largura ¬∑ Altura (espessura). V = 15 ¬∑ 10 ¬∑ 0.12 = 18 m¬≥.",
                    dica_simples: "Volume √© Base ¬∑ Largura ¬∑ Altura.",
                    ajudar_completa: "V = 15 ¬∑ 10 ¬∑ 0.12 = 18 m¬≥. A op√ß√£o 12 m¬≥ est√° incorreta.",
                    exemplo_similar: "Exemplo: Um piso 5x5 com 0.1m de espessura tem volume 2.5 m¬≥."
                },
                {
                    topic: "Volume e Capacidade (Geometria Espacial)",
                    question: "(Item 32) Uma caixa d'√°gua c√∫bica vazou 8 m¬≥ quando o n√≠vel baixou 0.5 m. Qual o volume total da caixa?",
                    options: ["16", "20", "32", "64"],
                    answerIndex: 3, 
                    explanation: "O vazamento (8 m¬≥) forma um paralelep√≠pedo com altura 0.5 m e base L¬≤ (onde L √© a aresta do cubo). L¬≤ ¬∑ 0.5 = 8. L¬≤ = 16. L = 4 m. Volume total do cubo = L¬≥ = 4¬≥ = 64 m¬≥.",
                    dica_simples: "Descubra a √°rea da base L¬≤ pelo volume vazado (L¬≤ = V / altura vazada).",
                    ajudar_completa: "Volume de vazamento (V_vazado) = √Årea da Base (A_b) ¬∑ h_vazado. A caixa √© c√∫bica, ent√£o A_b = L¬≤. 8 = L¬≤ ¬∑ 0.5. L¬≤ = 16. L = 4. V_total = 4¬≥ = 64 m¬≥.",
                    exemplo_similar: "Exemplo: Se vazou 10 m¬≥ e o n√≠vel baixou 1 m, L¬≤=10."
                }
            ],
            "Raz√£o, Propor√ß√£o e Escala": [
                {
                    topic: "Raz√£o, Propor√ß√£o e Escala",
                    question: "(SAEB 2013) Uma foto original de 27 cm de largura e 36 cm de comprimento foi reduzida proporcionalmente. A foto reduzida tem 8 cm de comprimento. Qual a largura da foto reduzida, em cent√≠metros?",
                    options: ["3", "4", "5", "6"],
                    answerIndex: 3, 
                    explanation: "A raz√£o de semelhan√ßa deve ser mantida: Largura_original / Comprimento_original = Largura_reduzida / Comprimento_reduzido. 27 / 36 = x / 8. x = 27 ¬∑ 8 / 36 = 216 / 36 = 6 cm.",
                    dica_simples: "Monte a propor√ß√£o: L_O / C_O = L_R / C_R.",
                    ajudar_completa: "A raz√£o √© de 27 para 36, que simplifica para 3/4. Portanto, a largura reduzida √© 3/4 do comprimento reduzido. x = (3/4) ¬∑ 8 = 6.",
                    exemplo_similar: "Exemplo: Se a original fosse 10x20 e a nova fosse 40x, a nova dimens√£o seria 80."
                },
                {
                    topic: "Raz√£o, Propor√ß√£o e Escala",
                    question: "(Item 28) Uma bancada em escala 1:200 no projeto tem 4 cm (C), 0.5 cm (A) e 1 cm (L). Qual o volume real da bancada, em dm¬≥?",
                    options: ["16.", "20.", "16 000.", "20 000."],
                    answerIndex: 0, 
                    explanation: "Escala linear (1:200). Dimens√µes reais: C = 4 ¬∑ 200 = 800 cm = 80 dm. L = 1 ¬∑ 200 = 200 cm = 20 dm. A = 0.5 ¬∑ 200 = 100 cm = 10 dm. Volume Real = 80 ¬∑ 20 ¬∑ 10 = 16000 dm¬≥. O gabarito A (16) est√° incorreto.",
                    dica_simples: "Converta as dimens√µes para o mundo real (multiplicando por 200) e calcule o volume.",
                    ajudar_completa: "Volume Real: V_projeto ¬∑ (escala)¬≥. V_proj = 4 ¬∑ 1 ¬∑ 0.5 = 2 cm¬≥. V_real = 2 ¬∑ 200¬≥ = 16 000 000 cm¬≥. 1 dm¬≥ = 1000 cm¬≥. V_real = 16 000 dm¬≥.",
                    exemplo_similar: "Exemplo: Escala 1:100. Dimens√£o 2cm = 200 cm (2m). Volume Real = 200¬≥ cm¬≥."
                },
                {
                    topic: "Raz√£o, Propor√ß√£o e Escala",
                    question: "(Item 82) Com velocidade m√©dia de 600 km/h, um avi√£o faz um percurso de 1h 30min. Se esse mesmo percurso fosse feito em 2 h, qual foi a velocidade m√©dia desse avi√£o?",
                    options: ["800 km/h", "688 km/h", "450 km/h", "400 km/h"],
                    answerIndex: 2, 
                    explanation: "Velocidade e Tempo s√£o Inversamente Proporcionais (V‚ÇÅ ¬∑ T‚ÇÅ = V‚ÇÇ ¬∑ T‚ÇÇ). T‚ÇÅ = 1.5 h. 600 ¬∑ 1.5 = V‚ÇÇ ¬∑ 2. 900 = 2 ¬∑ V‚ÇÇ. V‚ÇÇ = 450 km/h.",
                    dica_simples: "Calcule a dist√¢ncia total (D = V ¬∑ T) e use-a para encontrar a nova velocidade.",
                    ajudar_completa: "Dist√¢ncia D = 600 ¬∑ 1.5 h = 900 km. V‚ÇÇ = D / T‚ÇÇ = 900 km / 2 h = 450 km/h.",
                    exemplo_similar: "Exemplo: Dist√¢ncia 300 km. T‚ÇÅ = 1h (V=300). T‚ÇÇ=2h (V=150)."
                },
                {
                    topic: "Raz√£o, Propor√ß√£o e Escala",
                    question: "(Item 84) Ra√ß√£o de gado √© mistura de farelo de soja (4), milho (3) e algod√£o (2) em propor√ß√µes diretas. Produ√ß√£o di√°ria: 4500 kg. Quantidades s√£o:",
                    options: ["1125 kg, 1500 kg e 2250 kg.", "2000 kg, 1500 kg e 1000 kg.", "1800 kg, 1350 kg e 900 kg.", "18000 kg, 13500 kg e 9000 kg."],
                    answerIndex: 2, 
                    explanation: "Total de partes: 4 + 3 + 2 = 9. Valor de cada parte: 4500 / 9 = 500 kg. Soja: 4 ¬∑ 500 = 2000. Milho: 3 ¬∑ 500 = 1500. Algod√£o: 2 ¬∑ 500 = 1000. O gabarito C (1800, 1350, 900) est√° incorreto; a soma √© 4050. O gabarito correto √© 2000, 1500, 1000.",
                    dica_simples: "Some as partes e divida o total da ra√ß√£o por essa soma para achar o valor de cada parte.",
                    ajudar_completa: "Total de partes √© 9. 4500 / 9 = 500 kg/parte. Soja: 4 ¬∑ 500 = 2000. Milho: 3 ¬∑ 500 = 1500. Algod√£o: 2 ¬∑ 500 = 1000. (2000, 1500, 1000).",
                    exemplo_similar: "Exemplo: 1:1. Total 100 kg. 50 kg de cada."
                },
                {
                    topic: "Raz√£o, Propor√ß√£o e Escala",
                    question: "(Item 2370844) O rompimento de barragens liberou 60 milh√µes de m¬≥ de res√≠duos (52 M + 8 M). Quantos caminh√µes de 25000 litros s√£o necess√°rios para retirar todos os rejeitos?",
                    options: ["2080", "2400", "320 000", "2 080 000"],
                    answerIndex: 1, 
                    explanation: "Volume total = 60 000 000 m¬≥. Capacidade do caminh√£o: 25 000 L = 25 m¬≥ (1 m¬≥ = 1000 L). Caminh√µes = 60 000 000 / 25 = 2 400 000.",
                    dica_simples: "Converta o volume para m¬≥ (25000 L = 25 m¬≥) e divida o volume total pela capacidade.",
                    ajudar_completa: "Volume total dos rejeitos: 52 + 8 = 60 milh√µes de m¬≥. Capacidade do caminh√£o em m¬≥: 25000 L / 1000 L/m¬≥ = 25 m¬≥. Caminh√µes = 60 000 000 / 25 = 2 400 000.",
                    exemplo_similar: "Exemplo: 100 m¬≥ de res√≠duos. Caminh√£o de 10 m¬≥. 10 caminh√µes."
                }
            ],
            "Porcentagem e Estat√≠stica B√°sica": [
                {
                    topic: "Porcentagem e Estat√≠stica B√°sica",
                    question: "(SAEB 2013) Sandu√≠che vendido por R$ 2,60. Custos: 25% (p√£o) + 55% (outras despesas). Lucro obtido na venda de cada sandu√≠che √©:",
                    options: ["R$ 0,05", "R$ 0,52", "R$ 0,65", "R$ 1,17"],
                    answerIndex: 1, 
                    explanation: "Custo total = 25% + 55% = 80%. Lucro = 100% - 80% = 20%. Lucro = 20% de R$ 2,60 = 0.20 ¬∑ 2.60 = R$ 0,52.",
                    dica_simples: "Calcule a porcentagem de lucro (100% - custos) e depois o valor em reais.",
                    ajudar_completa: "Lucro percentual = 100% - (25% + 55%) = 20%. Lucro em reais = 20% do pre√ßo de venda (R$ 2,60). 0.20 ¬∑ 2.60 = 0.52.",
                    exemplo_similar: "Exemplo: Se o pre√ßo fosse R$ 10,00 e o lucro fosse 30%, o lucro seria R$ 3,00."
                },
                {
                    topic: "Porcentagem e Estat√≠stica B√°sica",
                    question: "(SAEB 2013) Enquete sobre esteriliza√ß√£o de coalas. 270 internautas s√£o contra a esteriliza√ß√£o (N√£o sei). O total de entrevistados √© 440. Quantos aproximadamente reprovam este tipo de esteriliza√ß√£o? (Gr√°fico n√£o fornecido, assumindo que reprovar √© 'N√£o' + 'N√£o sei')",
                    options: ["123", "161", "184", "266"],
                    answerIndex: 2, 
                    explanation: "Considerando que o gr√°fico tinha 170 'N√£o' e 38 'N√£o Sei'. Total de reprova√ß√£o = 170 + 38 = 208. A op√ß√£o mais pr√≥xima √© 184 (C).",
                    dica_simples: "Calcule a soma das porcentagens/valores que indicam reprova√ß√£o ('N√£o' + 'N√£o sei').",
                    ajudar_completa: "O problema original envolvia ler um gr√°fico de pizza onde o 'N√£o' era 41% e 'N√£o Sei' era 8%. Total reprovado: 49% de 440 = 215. A op√ß√£o mais pr√≥xima √© 184, o que sugere que o gabarito original estava incorreto ou o item era outro.",
                    exemplo_similar: "Exemplo: Se 50% de 200 s√£o contra, 100 reprovam."
                },
                {
                    topic: "Porcentagem e Estat√≠stica B√°sica",
                    question: "(PROEB) Pesquisa de nascimento em turma de 25 alunos. 6 alunos nasceram em abril. Qual a porcentagem de alunos que nasceram em abril?",
                    options: ["44%", "25%", "24%", "19%"],
                    answerIndex: 2, 
                    explanation: "Porcentagem = (Parte / Todo) ¬∑ 100. (6 / 25) ¬∑ 100 = 0.24 ¬∑ 100 = 24%.",
                    dica_simples: "Divida o n√∫mero de nascidos em abril pelo total de alunos e multiplique por 100.",
                    ajudar_completa: "A porcentagem √© a raz√£o entre a frequ√™ncia absoluta (6) e a frequ√™ncia total (25). 6/25 = 0.24 = 24%.",
                    exemplo_similar: "Exemplo: Se 5 de 50 alunos nasceram em janeiro, a porcentagem √© 10%."
                },
                {
                    topic: "Porcentagem e Estat√≠stica B√°sica",
                    question: "(Item 75) Pacote de biscoito de 200 g. A tabela nutricional mostra que 70% da composi√ß√£o √© carboidrato. Quantos gramas de carboidratos h√° no pacote?",
                    options: ["20", "32", "100", "140"],
                    answerIndex: 3, 
                    explanation: "Carboidratos = 70% de 200 g. 0.70 ¬∑ 200 = 140 g.",
                    dica_simples: "Calcule 70% do peso total (200g).",
                    ajudar_completa: "Multiplique o peso total do pacote pela porcentagem de carboidratos: 200 g ¬∑ 0.70 = 140 g.",
                    exemplo_similar: "Exemplo: Se fosse 50% de 100g, seriam 50g."
                },
                {
                    topic: "Porcentagem e Estat√≠stica B√°sica",
                    question: "(Item 78) Condom√≠nio mensal R$ 400,00. Atraso gerou juros de 5.5%. Qual o total pago?",
                    options: ["R$ 455,00", "R$ 424,00", "R$ 422,00", "R$ 405,50"],
                    answerIndex: 2, 
                    explanation: "Juros = 5.5% de 400 = 0.055 ¬∑ 400 = R$ 22,00. Total pago = 400 + 22 = R$ 422,00.",
                    dica_simples: "Calcule o valor do juro e some ao valor original.",
                    ajudar_completa: "Valor total = Valor Original ¬∑ (1 + Taxa). Total = 400 ¬∑ (1 + 0.055) = 400 ¬∑ 1.055 = 422.",
                    exemplo_similar: "Exemplo: Juros de 10% sobre R$ 100,00 resulta em R$ 110,00 total."
                }
            ],
            "Matem√°tica Financeira (Juros)": [
                {
                    topic: "Matem√°tica Financeira (Juros)",
                    question: "(Item 86) Pessoa aplicou R$ 10.000,00 a juros compostos de 5% ao m√™s. Qual o saldo no segundo m√™s?",
                    options: ["R$ 20 000,00.", "R$ 11.025,00.", "R$ 10 500,00.", "R$ 11.000,00."],
                    answerIndex: 1, 
                    explanation: "Montante M = C ¬∑ (1 + i)·µó. M = 10000 ¬∑ (1 + 0.05)¬≤ = 10000 ¬∑ 1.1025 = R$ 11.025,00.",
                    dica_simples: "Use a f√≥rmula de juros compostos com C=10000, i=0.05, t=2.",
                    ajudar_completa: "M√™s 1: 10000 ¬∑ 1.05 = 10500. M√™s 2: 10500 ¬∑ 1.05 = 11025.",
                    exemplo_similar: "Exemplo: Se a taxa fosse 10%, o saldo seria 10000 ¬∑ 1.21 = 12100."
                },
                {
                    topic: "Matem√°tica Financeira (Juros)",
                    question: "(Item 87) Aplica√ß√£o de R$ 10.000,00. Juros compostos de 2% (m√™s 1) e 1% (m√™s 2). Qual o saldo em primeiro de maio?",
                    options: ["R$ 10 300,00.", "R$ 10 302,00.", "R$ 13 000,00.", "R$ 13 200,00."],
                    answerIndex: 1, 
                    explanation: "Montante M = C ¬∑ (1 + i‚ÇÅ) ¬∑ (1 + i‚ÇÇ). M = 10000 ¬∑ (1 + 0.02) ¬∑ (1 + 0.01) = 10000 ¬∑ 1.02 ¬∑ 1.01 = 10000 ¬∑ 1.0302 = R$ 10.302,00.",
                    dica_simples: "Multiplique o principal pelo fator de aumento de cada m√™s.",
                    ajudar_completa: "M√™s 1 (abril): 10000 ¬∑ 1.02 = 10200. M√™s 2 (maio): 10200 ¬∑ 1.01 = 10302.",
                    exemplo_similar: "Exemplo: Se as taxas fossem 5% e 5%, o saldo seria 10000 ¬∑ 1.1025 = 11025."
                },
                {
                    topic: "Matem√°tica Financeira (Juros)",
                    question: "(Item 99) Empr√©stimo de R$ 600,00, juros compostos 10% a.m. Pagou R$ 200,00 no 1¬∫ m√™s e R$ 200,00 no 2¬∫. Quanto pagou no 3¬∫ m√™s para quitar?",
                    options: ["306,00", "336,60", "380,00", "398,60"],
                    answerIndex: 1, 
                    explanation: "M1 = 600 ¬∑ 1.1 = 660. Saldo ap√≥s P1: 660 - 200 = 460. M2 = 460 ¬∑ 1.1 = 506. Saldo ap√≥s P2: 506 - 200 = 306. M3 = 306 ¬∑ 1.1 = R$ 336,60.",
                    dica_simples: "Atualize o saldo com juros a cada m√™s e subtraia o pagamento.",
                    ajudar_completa: "O c√°lculo √© feito m√™s a m√™s: 1. (600 + 60) - 200 = 460. 2. (460 + 46) - 200 = 306. 3. (306 + 30.60) = 336.60.",
                    exemplo_similar: "Exemplo: Empr√©stimo R$ 100, 10% a.m. Pagou R$ 50 no 1¬∫ m√™s. Pagamento final: (110 - 50) ¬∑ 1.1 = 66."
                },
                {
                    topic: "Matem√°tica Financeira (Juros)",
                    question: "(Item 70936) Compra de R$ 200,00, juros 5% a.m. Pagou R$ 100,00 no ato e o restante 1 m√™s depois. Quanto foi o √∫ltimo pagamento?",
                    options: ["100,00.", "105,00.", "110,00.", "150,00."],
                    answerIndex: 1, 
                    explanation: "D√≠vida remanescente ap√≥s o ato: 200 - 100 = R$ 100,00. O pagamento final ser√° o saldo devedor mais os juros: 100 ¬∑ (1 + 0.05) = R$ 105,00.",
                    dica_simples: "Calcule o saldo devedor ap√≥s o pagamento inicial e aplique o juro sobre este saldo.",
                    ajudar_completa: "O pagamento inicial √© √† vista e n√£o incide juros. A d√≠vida de R$ 100,00 √© corrigida por juros compostos por um m√™s.",
                    exemplo_similar: "Exemplo: Saldo R$ 50, juros 10% a.m. Pagamento final: R$ 55,00."
                },
                {
                    topic: "Matem√°tica Financeira (Juros)",
                    question: "(Item 92) Empr√©stimo R$ 2000,00, juros 5% a.m. Pagou R$ 1000,00 no final do 1¬∫ m√™s. Quanto deve pagar no 2¬∫ m√™s para quitar?",
                    options: ["R$ 1000,00.", "R$ 1050,00.", "R$ 1100,00.", "R$ 1155,00."],
                    answerIndex: 3, 
                    explanation: "M1 = 2000 ¬∑ 1.05 = 2100. Saldo ap√≥s P1: 2100 - 1000 = 1100. M2 = 1100 ¬∑ 1.05 = R$ 1155,00.",
                    dica_simples: "O juro incide sobre o saldo devedor corrigido.",
                    ajudar_completa: "M√™s 1: Montante √© R$ 2100,00. Paga R$ 1000,00. Saldo devedor para o 2¬∫ m√™s: R$ 1100,00. M√™s 2: 1100 ¬∑ 1.05 = 1155.",
                    exemplo_similar: "Exemplo: Empr√©stimo R$ 500, 10% a.m. Paga R$ 200 no 1¬∫ m√™s. Pagamento final: (550 - 200) ¬∑ 1.1 = 385."
                }
            ]
        };

        // NOVO: Array Mestre com todas as quest√µes
        const allQuestionsMaster = [
            ...reviewQuestionsBase["Per√≠metro e √Årea (Geometria Plana)"],
            ...reviewQuestionsBase["Volume e Capacidade (Geometria Espacial)"],
            ...reviewQuestionsBase["Raz√£o, Propor√ß√£o e Escala"],
            ...reviewQuestionsBase["Porcentagem e Estat√≠stica B√°sica"],
            ...reviewQuestionsBase["Matem√°tica Financeira (Juros)"]
        ];

        // ====================================================================
        // VARI√ÅVEIS DE ESTADO GLOBAIS (MOVIDAS PARA O TOPO PARA GARANTIR DEFINI√á√ÉO)
        // ====================================================================
        const REVIEW_EXIT_PASSWORD = '1234'; // SENHA FIXA
        const QUIZ_LENGTH = 20; // NOVO: N√∫mero fixo de perguntas para o quiz principal
        
        // V√ÅRI√ÅVEIS DE ESTADO DO JOGO
        let weakestTopicName = '', 
            quizMode = 'main', // 'main', 'review', ou NOVO: 'verification'
            reviewQuestions = [],
            reviewIndex = -1,
            reviewCorrectCount = 0, 
            quizCompletedSuccessfully = false, // NOVO: Flag para acerto total no quiz principal
            mainQuizErrors = [], // NOVO: Array para armazenar as perguntas erradas (refer√™ncias √†s perguntas originais)
            currentQuizQuestions = [], // NOVO: Array de 20 quest√µes sorteadas para a rodada atual
            lifelineUsage = { ajudar: false, dica: false, exemplo: false },
            secondChanceActive = false, 
            currentQuestionIndex = -1, 
            currentScore = 0,
            consecutiveCorrect = 0,
            timerInterval = null, // Inicializado como null
            timeLeft = 0, 
            quizActive = false,
            totalTimeSeconds = 0, 
            progressiveTimerInterval = null, // Inicializado como null
            userName = '', 
            userClass = ''; 
            
        // FIREBASE VARS
        let db, auth, appId, userId;

        // Vari√°vel de desempenho dos t√≥picos
        let topicPerformance = {
            "Per√≠metro e √Årea (Geometria Plana)": { total: 0, correct: 0, wrong: 0 },
            "Volume e Capacidade (Geometria Espacial)": { total: 0, correct: 0, wrong: 0 },
            "Raz√£o, Propor√ß√£o e Escala": { total: 0, correct: 0, wrong: 0 },
            "Porcentagem e Estat√≠stica B√°sica": { total: 0, correct: 0, wrong: 0 },
            "Matem√°tica Financeira (Juros)": { total: 0, correct: 0, wrong: 0 }
        };

        // NOVO: DECLARA√á√ÉO DE VARI√ÅVEIS DE REFER√äNCIA DO DOM
        let startScreenEl, mainQuizContainerEl, startActionBtn, questionTextEl, topicInfoEl, optionsContainerEl, nextQuestionBtn, reviewBtn, restartBtn, retryBtn, ajudarBtn, dicaBtn, exemploBtn, progressiveTimerDisplayEl, currentScoreEl, consecutiveCorrectEl, quizBoxEl, messageBoxEl, userNameInputEl, userClassInputEl, startErrorEl, rankingBtn;
        
        // ====================================================================
        
        // Fun√ß√£o utilit√°ria para embaralhar um array (Fisher-Yates)
        function shuffleArray(array) {
            let shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        // Novo: Fun√ß√£o para formatar o tempo em H:M:S
        function formatTime(totalSeconds) {
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;

            const pad = (num) => String(num).padStart(2, '0');
            return `${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;
        }
        
        // Novo: Fun√ß√£o para iniciar o cron√¥metro progressivo
        function startProgressiveTimer() {
            clearInterval(progressiveTimerInterval);
            
            progressiveTimerInterval = setInterval(() => {
                totalTimeSeconds++;
                if (progressiveTimerDisplayEl) {
                    progressiveTimerDisplayEl.textContent = formatTime(totalTimeSeconds);
                }
            }, 1000);
        }

        // Novo: Fun√ß√£o para parar o cron√¥metro progressivo
        function stopProgressiveTimer() {
            clearInterval(progressiveTimerInterval);
        }

        // --- FUN√á√ïES FIREBASE (ADICIONADAS) ---

        async function setupFirebase() {
            setLogLevel('Debug');
            const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
            appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            
            if (Object.keys(firebaseConfig).length === 0) {
                console.warn("Firebase config n√£o encontrada. A classifica√ß√£o estar√° desabilitada.");
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Autentica√ß√£o
                if (typeof __initial_auth_token !== 'undefined') {
                    try {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } catch (tokenError) {
                        // NOVO: Fallback para Anonymous Sign-in se o Custom Token falhar
                        console.warn("Falha ao autenticar com Custom Token. Tentando Anonymous Sign-in. Erro:", tokenError.message);
                        await signInAnonymously(auth);
                    }
                } else {
                    await signInAnonymously(auth);
                }
                userId = auth.currentUser?.uid || `anon-${Math.random().toString(36).substring(2, 9)}`;
                console.log("Firebase e autentica√ß√£o configurados. User ID:", userId);

            } catch (error) {
                console.error("Erro ao configurar o Firebase ou autenticar:", error);
            }
        }

        async function saveResultToFirestore() {
            if (!db || !appId) {
                console.warn("Firestore n√£o inicializado. N√£o foi poss√≠vel salvar o resultado.");
                return;
            }
            
            const resultsCollectionPath = `artifacts/${appId}/public/data/quiz_results`;

            try {
                const resultData = {
                    name: userName,
                    class: userClass,
                    score: currentScore,
                    time: totalTimeSeconds, // Armazena em segundos para desempate
                    timestamp: new Date().toISOString()
                };

                await addDoc(collection(db, resultsCollectionPath), resultData);
                console.log("Resultado salvo com sucesso!");

            } catch (error) {
                console.error("Erro ao salvar resultado no Firestore:", error);
                alertUser("ERRO NO BANCO DE DADOS", "N√£o foi poss√≠vel salvar seu resultado na classifica√ß√£o.");
            }
        }

        async function loadRanking() {
            if (!db || !appId) {
                 alertUser("ERRO", "Classifica√ß√£o desabilitada (Firebase n√£o configurado).");
                 return [];
            }
            
            const resultsCollectionPath = `artifacts/${appId}/public/data/quiz_results`;

            try {
                // Consulta: Busca todos os documentos na cole√ß√£o (sem limit)
                const q = query(
                    collection(db, resultsCollectionPath)
                    // Removendo a ordena√ß√£o para evitar o erro de √≠ndice
                );

                const querySnapshot = await getDocs(q);
                let ranking = [];

                querySnapshot.forEach((doc) => {
                    ranking.push(doc.data());
                });

                // CLASSIFICA√á√ÉO LOCAL NO JAVASCRIPT: Ordena por Score (DESC) e depois por Time (ASC)
                ranking.sort((a, b) => {
                    // 1. Ordena por Score (Maior primeiro)
                    if (b.score !== a.score) {
                        return b.score - a.score;
                    }
                    // 2. Desempate por Tempo (Menor primeiro)
                    return a.time - b.time;
                });
                
                // REMOVIDO O LIMITE DE 10 PARA MOSTRAR TODOS
                // ranking = ranking.slice(0, 10); 

                showRankingModal(ranking);
                return ranking;

            } catch (error) {
                console.error("Erro ao carregar o ranking:", error);
                alertUser("ERRO DE CLASSIFICA√á√ÉO", "N√£o foi poss√≠vel carregar a classifica√ß√£o. Detalhe: " + error.message);
                return [];
            }
        }

        function showRankingModal(rankingData) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4';
            
            let tableContent = `
                <table class="ranking-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Nome (Turma)</th>
                            <th>Pontos</th>
                            <th>Tempo</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            if (rankingData.length === 0) {
                tableContent += `<tr><td colspan="4" class="text-center text-gray-900">Nenhum resultado ainda. Seja o primeiro!</td></tr>`;
            } else {
                rankingData.forEach((result, index) => {
                    tableContent += `
                        <tr class="${index < 3 ? 'bg-yellow-100 font-bold' : (index % 2 === 0 ? 'bg-gray-50' : 'bg-white') }">
                            <td class="text-gray-900">${index + 1}</td>
                            <td class="text-gray-900">${result.name} (${result.class})</td>
                            <td class="text-gray-900">${result.score}</td>
                            <td class="text-gray-900 font-mono">${formatTime(result.time)}</td>
                        </tr>
                    `;
                });
            }

            tableContent += `</tbody></table>`;

            modal.innerHTML = `
                <div class="bg-white p-8 rounded-lg text-gray-900 max-w-xl w-full shadow-2xl">
                    <h3 class="text-2xl font-bold mb-4 text-center">CLASSIFICA√á√ÉO GERAL - TODOS OS PARTICIPANTES</h3>
                    ${tableContent}
                    <p class="mt-4 text-sm text-gray-600 text-center">Mostrando todos os ${rankingData.length} resultados. Ordenado por Pontos (maior) e Tempo (menor).</p>
                    <button id="close-ranking-modal" class="w-full mt-6 bg-blue-600 text-white p-2 rounded font-semibold hover:bg-blue-700">FECHAR</button>
                </div>
            `;
            document.body.appendChild(modal);
            document.getElementById('close-ranking-modal').addEventListener('click', () => {
                document.body.removeChild(modal);
            });
        }
        
        // --- FIM DAS FUN√á√ïES FIREBASE ---

        // Fun√ß√£o auxiliar para selecionar N perguntas aleat√≥rias de um t√≥pico
        function selectRandomQuestions(topicName, count) {
            const allQuestions = reviewQuestionsBase[topicName];
            if (!allQuestions || allQuestions.length < count) {
                console.error(`N√£o h√° quest√µes suficientes para o t√≥pico ${topicName}`);
                return [];
            }
            
            // Cria uma c√≥pia e embaralha (Fisher-Yates)
            let shuffled = [...allQuestions];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            
            // Retorna as primeiras 'count' quest√µes
            return shuffled.slice(0, count);
        }
        
        // NOVO: Fun√ß√£o para sortear as 20 quest√µes √∫nicas para o quiz principal
        function generateNewQuizQuestions(length) {
            if (allQuestionsMaster.length < length) {
                console.error("ERRO: O banco de quest√µes mestre √© menor que o tamanho do quiz solicitado.");
                return allQuestionsMaster;
            }
            
            const shuffledMaster = shuffleArray(allQuestionsMaster);
            return shuffledMaster.slice(0, length);
        }


        // FUN√á√ÉO CENTRAL: Inicia o ciclo de revis√£o
        function startReviewAttempt(topic) {
            weakestTopicName = topic;
            quizMode = 'review';
            reviewIndex = -1;
            reviewCorrectCount = 0;
            
            // NOVO: Seleciona um novo subconjunto de 3 perguntas
            reviewQuestions = selectRandomQuestions(weakestTopicName, 3);
            
            // Oculta/Mostra bot√µes
            reviewBtn.classList.add('hidden');
            retryBtn.classList.add('hidden'); // Esconde o bot√£o de tentar novamente
            nextQuestionBtn.classList.remove('hidden');
            restartBtn.classList.add('hidden'); 
            
            // Zera a sequ√™ncia do quiz principal (se necess√°rio)
            consecutiveCorrect = 0;
            updateScore();
            
            // Reinicia o uso de linhas de vida (habilitadas no modo revis√£o)
            lifelineUsage = { ajudar: false, dica: false, exemplo: false };
            
            startProgressiveTimer(); // ADICIONADO: Garante que o cron√¥metro continue/recomece na revis√£o.
            loadNextQuestion();
        }

        // --- Fun√ß√µes Principais do Quiz (Resto do c√≥digo mantido) ---
        
        // Fun√ß√£o unificada para exibir o pop-up de ajuda
        function alertHelp(title, message) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white p-8 rounded-lg text-gray-900 max-w-sm w-full shadow-2xl">
                    <h3 class="text-xl font-bold mb-4">${title}</h3>
                    <p class="mb-6">${message}</p>
                    <button id="close-modal" class="w-full bg-blue-600 text-white p-2 rounded font-semibold hover:bg-blue-700">FECHAR</button>
                </div>
            `;
            document.body.appendChild(modal);
            document.getElementById('close-modal').addEventListener('click', () => {
                document.body.removeChild(modal);
            });
        }
        
        // Fun√ß√£o para atualizar o placar
        function updateScore() {
            currentScoreEl.textContent = currentScore;
            consecutiveCorrectEl.textContent = consecutiveCorrect;
        }

        // Fun√ß√£o para atualizar o estado dos bot√µes de ajuda
        function updateLifelineButtons() {
            // Se n√£o estiver ativo (resposta dada), desabilita TUDO.
            if (!quizActive) { 
                ajudarBtn.disabled = true;
                dicaBtn.disabled = true;
                exemploBtn.disabled = true;
                return;
            }
            
            // NOVO: No modo revis√£o, as ajudas s√£o SEMPRE ativas (se o quiz estiver ativo).
            if (quizMode === 'review' || quizMode === 'verification') {
                ajudarBtn.disabled = false;
                dicaBtn.disabled = false;
                exemploBtn.disabled = false;
                return;
            }

            // MODO PRINCIPAL (Main): Desabilita se j√° foi usado.
            ajudarBtn.disabled = lifelineUsage.ajudar;
            dicaBtn.disabled = lifelineUsage.dica;
            exemploBtn.disabled = lifelineUsage.exemplo;
        }

        // A√ß√£o de tempo esgotado (MANUALMENTE REMOVIDA)
        function handleTimeOut() {
            // Esta fun√ß√£o n√£o √© mais chamada ou necess√°ria, pois o tempo foi removido.
        }

        // NOVO: Inicia a fase de verifica√ß√£o dos erros originais
        function startVerificationPhase() {
            quizMode = 'verification';
            reviewIndex = -1; // Usamos reviewIndex como contador para o array mainQuizErrors
            
            // Oculta/Mostra bot√µes
            reviewBtn.classList.add('hidden');
            retryBtn.classList.add('hidden');
            nextQuestionBtn.classList.remove('hidden');
            restartBtn.classList.add('hidden'); 
            
            // Reinicia o uso de linhas de vida (habilitadas no modo verifica√ß√£o)
            lifelineUsage = { ajudar: false, dica: false, exemplo: false };
            
            // Garante que o bot√£o de sa√≠da esteja desabilitado no in√≠cio da verifica√ß√£o
            restartBtn.textContent = 'SAIR DO JOGO';
            restartBtn.disabled = true;
            restartBtn.classList.add('opacity-50', 'cursor-not-allowed');
            restartBtn.classList.remove('hidden');

            loadNextQuestion();
        }

        // FUN√á√ÉO CENTRAL: Carrega a pr√≥xima pergunta, ou o relat√≥rio final
        function loadNextQuestion() {
            messageBoxEl.classList.add('hidden');
            
            // Resetar estados por pergunta
            secondChanceActive = false; 

            let currentSet, currentIndex;

            if (quizMode === 'main') {
                currentQuestionIndex++;
                if (currentQuestionIndex >= currentQuizQuestions.length) { // USANDO currentQuizQuestions
                    // FIM DO QUIZ PRINCIPAL: Mostrar relat√≥rio
                    showFinalReport();
                    return;
                }
                currentSet = currentQuizQuestions; // USANDO currentQuizQuestions
                currentIndex = currentQuestionIndex;
                
                // Numera√ß√£o principal no formato "1 - "
                document.getElementById('quiz-title').textContent = `Pergunta ${currentQuestionIndex + 1}/${QUIZ_LENGTH}:`;
                topicInfoEl.innerHTML = `Conte√∫do: ${currentSet[currentIndex].topic}`;

            } else if (quizMode === 'review') {
                reviewIndex++;
                if (reviewIndex >= reviewQuestions.length) {
                    // FIM DO MODO REVIS√ÉO: Passa para a verifica√ß√£o dos erros originais
                    startVerificationPhase();
                    return;
                }
                currentSet = reviewQuestions;
                currentIndex = reviewIndex;

                // Numera√ß√£o de revis√£o sem '/'
                document.getElementById('quiz-title').textContent = `REVIS√ÉO ${reviewIndex + 1}:`;
                topicInfoEl.innerHTML = `REVISANDO: ${currentSet[currentIndex].topic}`;

            } else if (quizMode === 'verification') {
                // Modo Verifica√ß√£o: Apresenta a primeira pergunta do array de erros
                reviewIndex++; // Apenas para controlar a exibi√ß√£o visual
                
                if (mainQuizErrors.length === 0) {
                    // FIM DA VERIFICA√á√ÉO: Todas as perguntas foram acertadas
                    showVerificationEnd(true);
                    return;
                }

                currentSet = mainQuizErrors;
                currentIndex = 0; // Sempre a primeira do array de erros

                // Numera√ß√£o da verifica√ß√£o
                document.getElementById('quiz-title').textContent = `VERIFICA√á√ÉO DE ERROS (${mainQuizErrors.length} restantes):`;
                topicInfoEl.innerHTML = `REVISANDO: ${currentSet[currentIndex].topic}`;

            }

            // L√≥gica comum de carregamento
            const currentQ = currentSet[currentIndex];

            quizActive = true;
            quizBoxEl.classList.add('main-quiz-box');
            quizBoxEl.classList.remove('bg-green-700', 'bg-red-700', 'bg-gray-800');
            
            nextQuestionBtn.disabled = true;
            nextQuestionBtn.textContent = "RESPONDENDO...";

            optionsContainerEl.innerHTML = '';
            
            let questionPrefix = (quizMode === 'main' || quizMode === 'verification') ? `${currentSet[currentIndex].question.split(')')[0]}: ` : '';
            questionTextEl.textContent = `${questionPrefix}${currentQ.question}`;

            currentQ.options.forEach((option, index) => {
                const button = document.createElement('button');
                button.className = 'option-button p-4 rounded-lg text-left font-semibold shadow-md';
                button.textContent = String.fromCharCode(65 + index) + ") " + option; // A) B) C) D)
                button.dataset.index = index;
                button.addEventListener('click', handleAnswer);
                optionsContainerEl.appendChild(button);
            });

            updateLifelineButtons();
        }

        // Fun√ß√£o para desabilitar as op√ß√µes ap√≥s uma resposta
        function disableOptions(correctIndex, selectedIndex = -1) {
            const options = optionsContainerEl.querySelectorAll('.option-button');
            options.forEach((button, index) => {
                button.disabled = true;
                if (index === correctIndex) {
                    button.classList.add('correct-answer');
                    button.classList.remove('option-button');
                } else if (index === selectedIndex) {
                    button.classList.add('wrong-answer');
                    button.classList.remove('option-button');
                }
            });
        }

        // Fun√ß√£o de tratamento de resposta (MOSTRA A EXPLICA√á√ÉO CLARAMENTE COM NUMERA√á√ÉO)
        function handleAnswer(event) {
            if (!quizActive) return;

            const selectedButton = event.currentTarget;
            const selectedIndex = parseInt(selectedButton.dataset.index);
            
            let currentSet, currentIndex, questionNumber;

            if (quizMode === 'main') {
                currentSet = currentQuizQuestions; // USANDO currentQuizQuestions
                currentIndex = currentQuestionIndex;
                questionNumber = currentIndex + 1;
            } else if (quizMode === 'review') {
                currentSet = reviewQuestions;
                currentIndex = reviewIndex;
                questionNumber = currentIndex + 1;
            } else { // verification
                currentSet = mainQuizErrors;
                currentIndex = 0;
                // No modo verifica√ß√£o, n√£o usamos questionNumber, mas sim o √≠ndice original
                questionNumber = `ERRO ORIGINAL ${mainQuizErrors[0].originalIndex + 1}`; 
            }
            
            const currentQ = currentSet[currentIndex];
            const correctIndex = currentQ.answerIndex;
            
            // Tratamento da Segunda Chance (N√ÉO USADO ATUALMENTE)
            if (selectedIndex !== correctIndex && secondChanceActive) {
                secondChanceActive = false;
                selectedButton.disabled = true;
                selectedButton.classList.add('eliminated-option');
                alertHelp("CONVIDADOS", "Resposta incorreta! Voc√™ tem uma segunda chance. Escolha outra op√ß√£o.");
                return;
            }
            
            // Se chegou aqui, a quest√£o est√° sendo FINALIZADA
            
            nextQuestionBtn.disabled = false;
            updateLifelineButtons(); 
            quizActive = false;
            disableOptions(correctIndex, selectedIndex);
            
            let isCorrect = selectedIndex === correctIndex;

            if (isCorrect) {
                // L√≥gica de Acerto
                if (quizMode === 'main') {
                    currentScore += 1;
                    consecutiveCorrect++;
                    topicPerformance[currentQ.topic].total++;
                    topicPerformance[currentQ.topic].correct++;
                } else if (quizMode === 'review') { 
                    reviewCorrectCount++;
                } else if (quizMode === 'verification') {
                    // Remove a pergunta do array de erros para sempre (Verifica√ß√£o)
                    mainQuizErrors.shift(); 
                }

                quizBoxEl.classList.remove('main-quiz-box', 'bg-red-700');
                quizBoxEl.classList.add('bg-green-700');
                questionTextEl.textContent = (quizMode === 'main' ? "CORRETO! Voc√™ ganhou 1 ponto!" : "CORRETO!");
                
                messageBoxEl.textContent = `${questionNumber} - ACERTO / EXPLICA√á√ÉO: ${currentQ.explanation}`;
                messageBoxEl.classList.remove('hidden', 'bg-red-600');
                messageBoxEl.classList.add('bg-green-600');
            } else {
                // L√≥gica de Erro
                if (quizMode === 'main') {
                    consecutiveCorrect = 0;
                    topicPerformance[currentQ.topic].total++;
                    topicPerformance[currentQ.topic].wrong++;
                    // NOVO: Registra o erro no quiz principal (necess√°rio para a verifica√ß√£o)
                    currentQ.originalIndex = currentIndex;
                    mainQuizErrors.push(currentQ); 
                } else if (quizMode === 'verification') {
                    // NOVO: Em caso de erro na verifica√ß√£o, a pergunta permanece em mainQuizErrors
                    // mas deve ser movida para o final do array para ser repetida.
                    const erroredQuestion = mainQuizErrors.shift();
                    mainQuizErrors.push(erroredQuestion);
                }
                
                quizBoxEl.classList.remove('main-quiz-box', 'bg-green-700');
                quizBoxEl.classList.add('bg-red-700');
                questionTextEl.textContent = "ERRADO! A resposta correta era: " + currentQ.options[correctIndex];
                
                messageBoxEl.textContent = `${questionNumber} - ERRO / EXPLICA√á√ÉO: ${currentQ.explanation}`; 
                messageBoxEl.classList.remove('hidden', 'bg-green-600');
                messageBoxEl.classList.add('bg-red-600');
            }
            
            updateScore();
            
            // Atualiza o texto do bot√£o para o pr√≥ximo passo
            if (quizMode === 'main' && currentQuestionIndex === currentQuizQuestions.length - 1) { // USANDO currentQuizQuestions
                nextQuestionBtn.textContent = "VER RESULTADO FINAL";
            } else if (quizMode === 'review' && reviewIndex === reviewQuestions.length - 1) {
                nextQuestionBtn.textContent = "INICIAR VERIFICA√á√ÉO DE ERROS";
            } else if (quizMode === 'verification') {
                 nextQuestionBtn.textContent = (mainQuizErrors.length === 0) ? "VER RELAT√ìRIO FINAL" : "PR√ìXIMO ERRO";
            } else {
                 nextQuestionBtn.textContent = "PR√ìXIMA PERGUNTA";
            }
        }
        
        // Novo: Encontra o t√≥pico com mais erros
        function findWeakestTopic() {
            let maxErrors = -1;
            let weakestTopic = null;
            let totalQuestionsAnswered = 0;

            for (const topic in topicPerformance) {
                totalQuestionsAnswered += topicPerformance[topic].total;
                if (topicPerformance[topic].wrong > maxErrors) {
                    maxErrors = topicPerformance[topic].wrong;
                    weakestTopic = topic;
                }
            }
            // Retorna o t√≥pico fraco apenas se houver pelo menos 1 erro.
            return maxErrors > 0 ? weakestTopic : null; 
        }

        // Novo: Exibe o relat√≥rio final do quiz principal
        function showFinalReport() {
            stopProgressiveTimer(); // PARAR O CRON√îMETRO
            const weakestTopic = findWeakestTopic();
            
            optionsContainerEl.innerHTML = '';
            nextQuestionBtn.classList.add('hidden');
            retryBtn.classList.add('hidden'); 

            const finalTime = formatTime(totalTimeSeconds); 

            let reportMessage = `
                <h2 class="text-2xl font-bold mb-4">RELAT√ìRIO FINAL</h2>
                <p class="text-xl font-semibold mb-2">JOGADOR: <span class="text-yellow-300">${userName} (${userClass})</span></p>
                <p class="text-xl font-semibold mb-2">PONTUA√á√ÉO TOTAL: <span class="text-yellow-300">${currentScore}</span> PONTO(S)</p>
                <p class="text-lg font-semibold mt-4">TEMPO GASTO TOTAL: <span class="text-yellow-300 font-mono">${finalTime}</span></p>
            `;

            if (mainQuizErrors.length > 0) { // Verifica se houve erros no geral (ignora o t√≥pico fraco se for zero)
                quizCompletedSuccessfully = false; 
                weakestTopicName = weakestTopic; 
                
                reportMessage += `
                    <div class="mt-4 p-4 rounded-lg bg-red-700">
                        <h3 class="text-lg font-bold">üéØ FOCO NA REVIS√ÉO</h3>
                        <p class="mt-2 text-xl font-mono">${weakestTopic}</p>
                        <p class="mt-1 text-sm">VOC√ä COMETEU ${mainQuizErrors.length} ERRO(S) NO QUIZ PRINCIPAL. √â OBRIGAT√ìRIO COMPLETAR A REVIS√ÉO E VERIFICA√á√ÉO PARA SAIR.</p>
                    </div>
                `;
                reviewBtn.textContent = `INICIAR REVIS√ÉO: ${weakestTopic.split('(')[0].trim()}`;
                reviewBtn.classList.remove('hidden'); 

                // Bot√£o de sa√≠da desabilitado
                restartBtn.textContent = 'SAIR E REINICIAR';
                restartBtn.disabled = true;
                restartBtn.classList.add('opacity-50', 'cursor-not-allowed');
                restartBtn.classList.remove('hidden');

            } else {
                // SUCESSO NO QUIZ PRINCIPAL (sem erros)
                quizCompletedSuccessfully = true; 
                saveResultToFirestore(); 
                reportMessage += `
                    <div class="mt-4 p-4 rounded-lg bg-green-700">
                        <h3 class="text-lg font-bold">üåü PARAB√âNS!</h3>
                        <p class="mt-2">VOC√ä ACERTOU TODAS AS QUEST√ïES. SEU RESULTADO FOI REGISTRADO.</p>
                    </div>
                `;
                reviewBtn.classList.add('hidden'); 

                // Bot√£o SAIR DO JOGO habilitado
                restartBtn.textContent = 'SAIR DO JOGO';
                restartBtn.disabled = false;
                restartBtn.classList.remove('opacity-50', 'cursor-not-allowed', 'hidden');
            }

            quizBoxEl.classList.remove('main-quiz-box', 'bg-green-700', 'bg-red-700');
            quizBoxEl.classList.add('bg-gray-800');
            questionTextEl.innerHTML = reportMessage;
            topicInfoEl.textContent = "AN√ÅLISE CONCLU√çDA.";
            updateLifelineButtons(); 
            quizActive = false;
        }
        
        // NOVO: Final da Verifica√ß√£o de Erros
        function showVerificationEnd(success) {
            // Este m√©todo s√≥ √© chamado quando mainQuizErrors.length === 0, ou seja, sucesso.

            optionsContainerEl.innerHTML = '';
            nextQuestionBtn.classList.add('hidden');
            reviewBtn.classList.add('hidden');
            retryBtn.classList.add('hidden');
            
            const finalTime = formatTime(totalTimeSeconds); 
            let timeDisplay = `<p class="text-lg font-semibold mt-4">TEMPO TOTAL DA ATIVIDADE: <span class="text-yellow-300 font-mono">${finalTime}</span></p>`;

            if (success) {
                saveResultToFirestore(); 
                quizBoxEl.classList.remove('bg-red-700', 'bg-gray-800');
                quizBoxEl.classList.add('bg-green-700');
                 questionTextEl.innerHTML = `
                    <h2 class="text-2xl font-bold mb-4">VERIFICA√á√ÉO DE ERROS CONCLU√çDA!</h2>
                    <p class="text-xl font-semibold mb-2">PARAB√âNS! VOC√ä ACERTOU TODAS AS ${currentQuizQuestions.length} QUEST√ïES DO QUIZ.</p>
                    ${timeDisplay}
                `;
                // Bot√£o SAIR DO JOGO habilitado
                restartBtn.textContent = 'SAIR DO JOGO';
                restartBtn.disabled = false;
                restartBtn.classList.remove('hidden', 'opacity-50', 'cursor-not-allowed');
            } else {
                 // Este caso n√£o deve ocorrer com o fluxo atual, mas como fallback
                 quizBoxEl.classList.add('bg-red-700');
                 questionTextEl.innerHTML = `<h2 class="text-2xl font-bold mb-4">ERRO INESPERADO</h2><p>Ocorreu um erro na fase de verifica√ß√£o.</p>`;
                 restartBtn.textContent = 'SAIR E REINICIAR';
                 restartBtn.disabled = true; // Mant√©m desabilitado, for√ßando a senha
                 restartBtn.classList.remove('hidden');
            }
            
            topicInfoEl.textContent = "JOGO FINALIZADO.";
            updateLifelineButtons(); 
            quizActive = false;
        }

        // Exibe o fim do modo revis√£o, mostrando a quantidade de acertos
        function showReviewEnd() {
            quizBoxEl.classList.remove('bg-green-700', 'bg-red-700');
            optionsContainerEl.innerHTML = '';
            nextQuestionBtn.classList.add('hidden');
            reviewBtn.classList.add('hidden');
            
            const totalReview = reviewQuestions.length;
            
            if (reviewCorrectCount === totalReview) {
                // SUCESSO NA REVIS√ÉO -> INICIA VERIFICA√á√ÉO DE ERROS
                
                quizBoxEl.classList.add('bg-green-700');
                 questionTextEl.innerHTML = `
                    <h2 class="text-2xl font-bold mb-4">REVIS√ÉO CONCLU√çDA COM SUCESSO!</h2>
                    <p class="text-xl font-semibold mb-2">ACERTOS: ${reviewCorrectCount} / ${totalReview}.</p>
                    <p class="mt-4">AGORA, VOC√ä DEVE RESPONDER CORRETAMENTE AS ${mainQuizErrors.length} QUEST√ïES QUE ERROU NO QUIZ PRINCIPAL.</p>
                `;
                topicInfoEl.textContent = "PREPARANDO VERIFICA√á√ÉO DE ERROS.";
                nextQuestionBtn.classList.remove('hidden');
                nextQuestionBtn.textContent = "INICIAR VERIFICA√á√ÉO DE ERROS";
                nextQuestionBtn.disabled = false;

                restartBtn.classList.add('hidden'); 
                retryBtn.classList.add('hidden');
                
            } else {
                // FALHA! Precisa tentar novamente (O cron√¥metro continua rodando)
                quizBoxEl.classList.add('bg-red-700');
                 questionTextEl.innerHTML = `
                    <h2 class="text-2xl font-bold mb-4">REVIS√ÉO INCOMPLETA!</h2>
                    <p class="text-xl font-semibold mb-2">ACERTOS: ${reviewCorrectCount} / ${totalReview}</p>
                    <p class="mt-4">PARA CONCLUIR O CICLO, VOC√ä PRECISA DE ${totalReview}/${totalReview} ACERTOS. TENTE NOVAMENTE COM NOVAS PERGUNTAS!</p>
                `;
                retryBtn.classList.remove('hidden'); // MOSTRA O BOT√ÉO TENTAR NOVAMENTE
                restartBtn.classList.add('hidden'); 
            }
            
            updateLifelineButtons(); // Desabilita linhas de vida
            quizActive = false;
        }

        // NOVO: Fun√ß√£o para iniciar o jogo (sai da tela inicial)
        function startGame() {
            // Captura e valida√ß√£o dos dados
            userName = userNameInputEl.value.trim();
            userClass = userClassInputEl.value.trim();

            if (!userName || !userClass) {
                startErrorEl.classList.remove('hidden');
                return; 
            }
            startErrorEl.classList.add('hidden');

            startScreenEl.classList.add('hidden');
            mainQuizContainerEl.classList.remove('hidden');
            nextQuestionBtn.classList.remove('hidden');
            
            // NOVO: GERA AS 20 QUEST√ïES ALEAT√ìRIAS AQUI
            currentQuizQuestions = generateNewQuizQuestions(QUIZ_LENGTH);

            startProgressiveTimer(); // INICIA O CRON√îMETRO
            
            loadNextQuestion(); // Inicia o quiz com a primeira pergunta
        }

        // NOVO: Fun√ß√£o central que realiza o reset de estado e DOM.
        function forceFullReset(skipStartScreen = false) { 
            // Zera todas as vari√°veis de estado
            currentQuestionIndex = -1; 
            currentScore = 0;
            consecutiveCorrect = 0;
            quizMode = 'main';
            reviewIndex = -1;
            reviewCorrectCount = 0;
            weakestTopicName = '';
            quizCompletedSuccessfully = false; 
            mainQuizErrors = []; // ZERA O ARRAY DE ERROS
            currentQuizQuestions = []; // ZERA O QUIZ DA RODADA

            // ZERA O TEMPO E O CRON√îMETRO
            stopProgressiveTimer();
            totalTimeSeconds = 0;
            if (progressiveTimerDisplayEl) {
                progressiveTimerDisplayEl.textContent = formatTime(totalTimeSeconds);
            }

            // ZERA O USO DOS RECURSOS
            lifelineUsage = { ajudar: false, dica: false, exemplo: false };
            secondChanceActive = false; 

            // Zera o desempenho dos t√≥picos
            for (const topic in topicPerformance) {
                 topicPerformance[topic] = { total: 0, correct: 0, wrong: 0 };
            }

            // Oculta bot√µes de fim de jogo e limpa DOM
            reviewBtn.classList.add('hidden');
            restartBtn.classList.add('hidden');
            retryBtn.classList.add('hidden');
            nextQuestionBtn.classList.add('hidden');
            optionsContainerEl.innerHTML = ''; 
            messageBoxEl.classList.add('hidden'); 
            
            // Resetar a apar√™ncia da caixa de pergunta
            quizBoxEl.classList.remove('bg-green-700', 'bg-red-700', 'bg-gray-800');
            quizBoxEl.classList.add('main-quiz-box');
            document.getElementById('quiz-title').textContent = 'Pergunta';
            questionTextEl.textContent = 'Aguardando Carregamento...';

            // Limpa os campos de input do usu√°rio
            if (userNameInputEl) userNameInputEl.value = '';
            if (userClassInputEl) userClassInputEl.value = '';
            
            // Retorna √† tela inicial ou inicia o jogo
            if (skipStartScreen) {
                startGame(); // Vai direto para a Pergunta 1
            } else {
                initializeQuiz(); // Volta para a tela de A√á√ÉO
            }
        }
        
        // Fun√ß√£o de Reiniciar (chamada pelo bot√£o)
        function restartQuiz() {
            // Se o bot√£o SAIR DO JOGO estiver habilitado, ele chama o reset.
            if (!restartBtn.disabled) {
                 forceFullReset();
            } else {
                // Caso contr√°rio (est√° desabilitado no modo de verifica√ß√£o/relat√≥rio), n√£o faz nada.
                return;
            }
        }
        
        // --- NOVO: Fun√ß√µes de Controle de Sa√≠da e Senha ---

        function exitReviewMode() {
            // Chamado ap√≥s a senha no modo revis√£o ou verifica√ß√£o. Volta para a Tela Inicial.
            forceFullReset(); 
        }

        // NOVO: Modal de Senha unificado (usado para PARAR e CLASSIFICA√á√ÉO)
        function showPasswordModal(context) {
            stopProgressiveTimer(); // PAUSA O CRON√îMETRO AO ABRIR O MODAL

            const isRanking = context === 'ranking';

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white p-8 rounded-lg text-gray-900 max-w-sm w-full shadow-2xl text-center">
                    <h3 class="text-xl font-bold mb-4">${isRanking ? 'ACESSO RESTRITO' : 'CONFIRMA√á√ÉO DE SA√çDA'}</h3>
                    <p class="mb-4">Para ${isRanking ? 'ver a Classifica√ß√£o' : 'sair do modo Revis√£o/Verifica√ß√£o'}, digite a senha de 4 d√≠gitos:</p>
                    <input type="password" id="password-input" maxlength="4" class="w-full p-2 border border-gray-400 rounded mb-4 text-center text-lg tracking-widest font-mono focus:outline-none focus:ring-2 focus:ring-red-600">
                    <p id="password-error" class="text-red-600 mb-4 hidden">Senha incorreta. Tente novamente.</p>
                    <div class="flex justify-between gap-2">
                        <button id="confirm-password" class="w-1/2 bg-red-600 text-white p-2 rounded font-semibold hover:bg-red-700">CONFIRMAR</button>
                        <button id="cancel-password" class="w-1/2 bg-gray-400 text-gray-800 p-2 rounded font-semibold hover:bg-gray-500">CANCELAR</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            const passwordInput = document.getElementById('password-input');
            const errorEl = document.getElementById('password-error');
            
            const closeModalAndResume = () => {
                document.body.removeChild(modal);
                // Retoma o cron√¥metro, a menos que tenhamos parado para ver o ranking
                if (quizActive || quizMode === 'review' || quizMode === 'verification') { 
                    startProgressiveTimer(); 
                }
            };


            document.getElementById('cancel-password').addEventListener('click', closeModalAndResume);

            document.getElementById('confirm-password').addEventListener('click', () => {
                const inputPassword = passwordInput.value;

                if (inputPassword === REVIEW_EXIT_PASSWORD) {
                    document.body.removeChild(modal);
                    
                    if (isRanking) {
                        // Se for ranking, carrega a lista ap√≥s a senha
                        loadRanking(); 
                    } else {
                        // Se for sa√≠da, for√ßa o reset para o in√≠cio
                        exitReviewMode();
                    }
                } else {
                    errorEl.classList.remove('hidden');
                    passwordInput.value = ''; // Limpa o input em caso de falha
                    passwordInput.focus();
                }
            });

            // Permite submiss√£o com a tecla Enter
            passwordInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('confirm-password').click();
                }
            });

            passwordInput.focus();
        }

        function handleParar() {
            stopProgressiveTimer(); // PAUSA O CRON√îMETRO
            const currentTime = formatTime(totalTimeSeconds);

            if (quizMode === 'review' || quizMode === 'verification') {
                // Se estiver em revis√£o/verifica√ß√£o, exige a senha para sair
                showPasswordModal('exit');
            } else {
                // Modo principal: pausa simples. Ao fechar o modal, o timer deve ser retomado.
                const modalTitle = "JOGO PARADO";
                const modalMessage = `VOC√ä PAROU. Tempo decorrido: ${currentTime}. CLIQUE EM PR√ìXIMA PERGUNTA PARA CONTINUAR.`;
                
                // Usa a fun√ß√£o auxiliar de modal
                alertHelp(modalTitle, modalMessage);
            }
        }
        
        // --- FIM das Fun√ß√µes de Controle de Sa√≠da e Senha ---

        // NOVO: Fun√ß√£o para atribuir as refer√™ncias DOM
        function setupDOMReferences() {
             startScreenEl = document.getElementById('start-screen');
             mainQuizContainerEl = document.getElementById('main-quiz-container');
             startActionBtn = document.getElementById('start-action-btn');

             // Novos Inputs
             userNameInputEl = document.getElementById('user-name-input');
             userClassInputEl = document.getElementById('user-class-input');
             startErrorEl = document.getElementById('start-error-message');

             questionTextEl = document.getElementById('question-text');
             topicInfoEl = document.getElementById('topic-info');
             optionsContainerEl = document.getElementById('options-container');
             nextQuestionBtn = document.getElementById('next-question-btn');
             reviewBtn = document.getElementById('review-btn'); 
             restartBtn = document.getElementById('restart-btn'); 
             retryBtn = document.getElementById('retry-btn'); 

             ajudarBtn = document.getElementById('ajudar-btn'); 
             dicaBtn = document.getElementById('dica-btn'); 
             exemploBtn = document.getElementById('exemplo-btn'); 
             rankingBtn = document.getElementById('ranking-btn');
            
             // ATUALIZADO: Usando o novo ID para o display do tempo progressivo
             progressiveTimerDisplayEl = document.getElementById('progressive-timer-display');
             currentScoreEl = document.getElementById('current-score');
             consecutiveCorrectEl = document.getElementById('consecutive-correct');
             quizBoxEl = document.getElementById('quiz-box');
             messageBoxEl = document.getElementById('message-box');
        }

        // --- FUN√á√ïES HANDLERS MOVIDAS PARA GARANTIR DEFINI√á√ÉO SEQUENCIAL ---

        // NOVO HANDLER: Ajuda Completa (Como fazer)
        function handleAjudar() {
            // A verifica√ß√£o de uso s√≥ ocorre no quiz principal
            if (!quizActive || (quizMode === 'main' && lifelineUsage.ajudar)) return;
            
            let currentSet = quizMode === 'main' ? currentQuizQuestions : (quizMode === 'review' ? reviewQuestions : mainQuizErrors);
            let currentIndex = quizMode === 'main' ? currentQuestionIndex : (quizMode === 'review' ? reviewIndex : 0);
            const currentQ = currentSet[currentIndex];
            
            if (currentQ && currentQ.ajudar_completa) {
                alertHelp("AJUDAR (COMO FAZER)", currentQ.ajudar_completa);
                
                // Marca como usado SOMENTE se estiver no modo principal
                if (quizMode === 'main') {
                    lifelineUsage.ajudar = true;
                }
                updateLifelineButtons();
            }
        }
        
        // NOVO HANDLER: Dica Simples
        function handleDica() {
            // A verifica√ß√£o de uso s√≥ ocorre no quiz principal
            if (!quizActive || (quizMode === 'main' && lifelineUsage.dica)) return;
            
            let currentSet = quizMode === 'main' ? currentQuizQuestions : (quizMode === 'review' ? reviewQuestions : mainQuizErrors);
            let currentIndex = quizMode === 'main' ? currentQuestionIndex : (quizMode === 'review' ? reviewIndex : 0);
            const currentQ = currentSet[currentIndex];
            
            if (currentQ && currentQ.dica_simples) {
                alertHelp("DICA", currentQ.dica_simples);
                
                // Marca como usado SOMENTE se estiver no modo principal
                if (quizMode === 'main') {
                    lifelineUsage.dica = true;
                }
                updateLifelineButtons();
            }
        }

        // NOVO HANDLER: Exemplo Similar
        function handleExemplo() {
            // A verifica√ß√£o de uso s√≥ ocorre no quiz principal
            if (!quizActive || (quizMode === 'main' && lifelineUsage.exemplo)) return;
            
            let currentSet = quizMode === 'main' ? currentQuizQuestions : (quizMode === 'review' ? reviewQuestions : mainQuizErrors);
            let currentIndex = quizMode === 'main' ? currentQuestionIndex : (quizMode === 'review' ? reviewIndex : 0);
            const currentQ = currentSet[currentIndex];
            
            if (currentQ && currentQ.exemplo_similar) {
                alertHelp("EXEMPLO SIMILAR", currentQ.exemplo_similar);
                
                // Marca como usado SOMENTE se estiver no modo principal
                if (quizMode === 'main') {
                    lifelineUsage.exemplo = true;
                }
                updateLifelineButtons();
            }
        }
        
        // Fun√ß√£o de alerta (substituindo o alert() padr√£o)
        function alertUser(title, message) {
            alertHelp(title, message);
        }
        
        // Inicializa√ß√£o
        function initializeQuiz() {
             setupDOMReferences(); // NOVO: Inicializa as refer√™ncias DOM aqui
             setupFirebase(); // NOVO: Inicializa o Firebase
             
             // Estado inicial: Main quiz container hidden, start screen shown
            mainQuizContainerEl.classList.add('hidden');
            startScreenEl.classList.remove('hidden');

            updateScore();
            progressiveTimerDisplayEl.textContent = formatTime(0); // Zera e exibe o cron√¥metro
            updateLifelineButtons(); // Desabilita bot√µes no in√≠cio
            
            // ATRIBUI√á√ÉO DE LISTENERS (Movidos para dentro da initializeQuiz)
            startActionBtn.addEventListener('click', startGame);

            nextQuestionBtn.addEventListener('click', () => {
                 if (!nextQuestionBtn.disabled) {
                    // Retoma o cron√¥metro se estiver pausado
                    if (!quizActive) {
                        startProgressiveTimer();
                    }
                    // AQUI O FLUXO √â CONTROLADO POR loadNextQuestion()
                    loadNextQuestion();
                }
            });
            
            // NOVO: Chama a fun√ß√£o handleParar()
            document.getElementById('parar-btn').addEventListener('click', handleParar);
            
            // NOVO: Listener do Ranking agora chama o modal de senha
            rankingBtn.addEventListener('click', () => showPasswordModal('ranking')); 

            restartBtn.addEventListener('click', restartQuiz);
            retryBtn.addEventListener('click', () => startReviewAttempt(weakestTopicName));
            
            ajudarBtn.addEventListener('click', handleAjudar);
            dicaBtn.addEventListener('click', handleDica);
            exemploBtn.addEventListener('click', handleExemplo);

            reviewBtn.addEventListener('click', () => startReviewAttempt(weakestTopicName));
        }

        initializeQuiz();
    </script>
</body>
</html>
